<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flappy Bird - Arcade</title>
    <script src="firebase-utils.js"></script>
    <style>
        #game-session-timer {
            font-size: 2.5rem !important;
            font-weight: 700 !important;
        }
    </style>
    <script>
        let timerIntervalId;
        let drainIntervalId;
        
        (async function() {
            await initializeFirebase();
            
            if (sessionStorage.getItem('validGameAccess') !== 'true') {
                alert('You must access this game from the Arcade page.');
                window.location.href = 'arcade.html';
                return;
            }
            
            function getUser() {
                return JSON.parse(localStorage.getItem('user') || '{}');
            }
            
            function saveUser(user) {
                localStorage.setItem('user', JSON.stringify(user));
            }

            function showOutOfTokensPopup() {
                clearInterval(timerIntervalId);
                clearInterval(drainIntervalId);
                
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);backdrop-filter:blur(4px);z-index:99999;display:flex;align-items:center;justify-content:center;';
                
                const modal = document.createElement('div');
                modal.style.cssText = 'background:white;border-radius:1rem;padding:2rem;max-width:400px;text-align:center;box-shadow:0 20px 25px rgba(0,0,0,0.3);';
                
                modal.innerHTML = `
                    <div style="font-size:3rem;margin-bottom:1rem;">💸</div>
                    <h2 style="font-size:1.5rem;font-weight:700;margin-bottom:1rem;color:#1e293b;">Out of Tokens!</h2>
                    <p style="margin-bottom:1.5rem;color:#64748b;">Your token balance hit zero.</p>
                    <p style="margin-bottom:1.5rem;color:#94a3b8;font-size:0.85rem;">Earn more tokens by completing lessons and quizzes!</p>
                    <button id="back-to-arcade" style="padding:0.75rem 1.5rem;border-radius:0.5rem;border:none;background:#f59e0b;color:#000;cursor:pointer;font-weight:700;font-size:1rem;">Back to Arcade</button>
                `;
                
                overlay.appendChild(modal);
                document.body.appendChild(overlay);
                
                modal.querySelector('#back-to-arcade').onclick = () => {
                    sessionStorage.removeItem('validGameAccess');
                    window.location.href = 'arcade.html';
                };
            }
            
            window.initializeTokenDrain = function() {
                const sidebar = document.getElementById('game-sidebar');
                if (!sidebar) return;
                
                let timerDisplay = document.getElementById('game-session-timer');
                if (!timerDisplay) {
                    timerDisplay = document.createElement('div');
                    timerDisplay.id = 'game-session-timer';
                    sidebar.appendChild(timerDisplay);
                }

                function updateTimerDisplay() {
                    const user = getUser();
                    const remaining = Math.max(0, user.points || 0);
                    timerDisplay.textContent = remaining + '💎';
                    timerDisplay.className = remaining <= 20 ? 'warning' : '';
                    
                    if (remaining <= 0) {
                        showOutOfTokensPopup();
                    }
                }
                
                function drainTokens() {
                    const user = getUser();
                    const pts = user.points || 0;
                    if (pts > 0) {
                        user.points = pts - 1;
                        saveUser(user);
                        updateTimerDisplay();
                    } else if (pts <= 0) {
                        showOutOfTokensPopup();
                    }
                }
                
                if (timerIntervalId) clearInterval(timerIntervalId);
                if (drainIntervalId) clearInterval(drainIntervalId);
                
                updateTimerDisplay();
                drainIntervalId = setInterval(drainTokens, 1000);
                
                // Pause drain when page is hidden
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        clearInterval(drainIntervalId);
                    } else {
                        drainIntervalId = setInterval(drainTokens, 1000);
                    }
                });
            };
            
            document.addEventListener('DOMContentLoaded', window.initializeTokenDrain);
        })();
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/main.css">
    <style>
        body { font-family: 'Orbitron', monospace; padding-top: 50px; }
        canvas { border-radius: 0.5rem; }
        #game {
            width: 100%;
            height: auto;
        }
        #game-wrapper { margin-left: 150px; width: min(720px, calc(100vw - 360px)); max-width: 100%; }
        #game-sidebar {
            background: rgba(55, 65, 81, 0.98); border-radius: 1rem; padding: 1.5rem;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start; width: 400px;
            min-height: 200px;
            border: 2px solid rgba(107, 114, 128, 0.9);
            box-shadow: 0 20px 45px rgba(0,0,0,0.6);
        }
    </style>
    <script src="theme_manager.js"></script>
</head>
<body class="dark-mode bg-gray-900 min-h-screen text-white">
<script src="scripts/taskbar.js"></script>

<!-- Translation Scripts -->
<script src="scripts/global_translations.js?v=8.0"></script>
<script src="scripts/spanish_translations.js?v=1.0"></script>
<script src="scripts/hindi_translations.js?v=1.0"></script>

<div class="flex flex-row items-start justify-start p-4 gap-10 overflow-x-auto overflow-y-visible">
    <div id="game-wrapper" class="relative flex-shrink-0 max-w-md bg-gray-800 rounded-2xl shadow-2xl p-6 border border-gray-700">
        <div class="flex justify-between items-end mb-4">
            <div>
                <h1 class="text-2xl font-bold bg-gradient-to-r from-cyan-400 to-teal-500 bg-clip-text text-transparent" data-i18n="FLAPPY BIRD">FLAPPY BIRD</h1>
                <p class="text-xs text-gray-400 font-sans" data-i18n="Tap to fly, dodge the pipes!">Tap to fly, dodge the pipes!</p>
            </div>
            <div class="text-right">
                <div class="text-xs text-gray-400 font-sans" data-i18n="SCORE">SCORE</div>
                <div id="score" class="text-3xl font-bold text-white">0</div>
            </div>
        </div>

        <canvas id="game" class="bg-gray-900 border-2 border-gray-700 mx-auto block" width="360" height="520"></canvas>

        <p class="text-center text-xs text-gray-500 mt-4 font-sans" data-i18n="Click / Space / Tap to flap">Click / Space / Tap to flap</p>

        <!-- Start Overlay -->
        <div id="start-screen" class="absolute inset-0 bg-black/80 rounded-2xl z-20 flex flex-col items-center justify-center text-center p-6 backdrop-blur-sm">
            <h2 class="text-3xl text-cyan-400 font-bold mb-4">🐦 FLAPPY BIRD</h2>
            <p class="text-gray-300 mb-4 font-sans">Tap to fly through the gaps!</p>
            <div class="text-left text-xs text-gray-400 font-sans mb-6 space-y-1">
                <p><span class="text-cyan-300 font-bold">Click / Space</span> — Flap</p>
                <p><span class="text-cyan-300 font-bold">Tap</span> — Flap (mobile)</p>
            </div>
            <button onclick="startGame()" class="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-8 rounded-lg shadow-lg transform transition active:scale-95">
                START
            </button>
        </div>

        <!-- Game Over Overlay -->
        <div id="game-over" class="hidden absolute inset-0 bg-black/90 rounded-2xl z-20 flex flex-col items-center justify-center text-center p-6 backdrop-blur-sm">
            <h2 class="text-3xl text-red-500 font-bold mb-2" data-i18n="GAME OVER">GAME OVER</h2>
            <p class="text-gray-300 mb-6 font-sans">You crashed!</p>
            <div class="text-4xl font-bold text-white mb-8" id="final-score">0</div>
            <button onclick="resetGame()" class="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-8 rounded-lg shadow-lg transform transition active:scale-95" data-i18n="TRY AGAIN">
                TRY AGAIN
            </button>
        </div>
    </div>

    <div id="game-sidebar">
        <div style="width:100%;text-align:center;color:#9ca3af;margin-bottom:1rem;font-size:0.875rem;font-weight:600;">
            ⭐ TOKEN SESSION
        </div>
    </div>
</div>

<script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const W = canvas.width, H = canvas.height;

    // Bird
    let birdY, birdVel, birdRadius = 14;
    const birdX = 80;
    const GRAVITY = 0.45;
    const FLAP = -7;

    // Pipes
    let pipes = [];
    const PIPE_WIDTH = 50;
    const PIPE_GAP = 140;
    const PIPE_SPEED = 2.5;
    let pipeTimer = 0;
    const PIPE_INTERVAL = 90;

    // State
    let score = 0;
    let gameRunning = false;
    let animFrame = null;

    function init() {
        birdY = H / 2;
        birdVel = 0;
        pipes = [];
        pipeTimer = 0;
        score = 0;
        document.getElementById('score').textContent = '0';
    }

    function flap() {
        if (!gameRunning) return;
        birdVel = FLAP;
    }

    function addPipe() {
        const minTop = 60;
        const maxTop = H - PIPE_GAP - 80;
        const topH = minTop + Math.random() * (maxTop - minTop);
        pipes.push({
            x: W,
            topH: topH,
            scored: false
        });
    }

    function update() {
        // Bird physics
        birdVel += GRAVITY;
        birdY += birdVel;

        // Pipe movement
        pipeTimer++;
        if (pipeTimer >= PIPE_INTERVAL) {
            addPipe();
            pipeTimer = 0;
        }

        for (let i = pipes.length - 1; i >= 0; i--) {
            pipes[i].x -= PIPE_SPEED;

            // Score
            if (!pipes[i].scored && pipes[i].x + PIPE_WIDTH < birdX) {
                pipes[i].scored = true;
                score++;
                document.getElementById('score').textContent = score;
            }

            // Remove off-screen
            if (pipes[i].x + PIPE_WIDTH < -10) pipes.splice(i, 1);
        }

        // Collision: ground/ceiling
        if (birdY + birdRadius > H || birdY - birdRadius < 0) { gameOver(); return; }

        // Collision: pipes
        for (const pipe of pipes) {
            if (birdX + birdRadius > pipe.x && birdX - birdRadius < pipe.x + PIPE_WIDTH) {
                if (birdY - birdRadius < pipe.topH || birdY + birdRadius > pipe.topH + PIPE_GAP) {
                    gameOver(); return;
                }
            }
        }
    }

    function draw() {
        // Sky gradient
        const skyGrad = ctx.createLinearGradient(0, 0, 0, H);
        skyGrad.addColorStop(0, '#0f172a');
        skyGrad.addColorStop(1, '#1e3a5f');
        ctx.fillStyle = skyGrad;
        ctx.fillRect(0, 0, W, H);

        // Stars
        ctx.fillStyle = 'rgba(255,255,255,0.3)';
        for (let i = 0; i < 30; i++) {
            const sx = (i * 137.5 + 23) % W;
            const sy = (i * 97.3 + 11) % (H * 0.6);
            ctx.beginPath();
            ctx.arc(sx, sy, 0.8, 0, Math.PI * 2);
            ctx.fill();
        }

        // Pipes
        for (const pipe of pipes) {
            // Top pipe
            const topGrad = ctx.createLinearGradient(pipe.x, 0, pipe.x + PIPE_WIDTH, 0);
            topGrad.addColorStop(0, '#22c55e');
            topGrad.addColorStop(0.5, '#16a34a');
            topGrad.addColorStop(1, '#15803d');
            ctx.fillStyle = topGrad;
            ctx.fillRect(pipe.x, 0, PIPE_WIDTH, pipe.topH);
            // Top pipe cap
            ctx.fillStyle = '#22c55e';
            ctx.fillRect(pipe.x - 4, pipe.topH - 16, PIPE_WIDTH + 8, 16);
            ctx.strokeStyle = '#15803d';
            ctx.lineWidth = 1;
            ctx.strokeRect(pipe.x - 4, pipe.topH - 16, PIPE_WIDTH + 8, 16);

            // Bottom pipe
            const botY = pipe.topH + PIPE_GAP;
            ctx.fillStyle = topGrad;
            ctx.fillRect(pipe.x, botY, PIPE_WIDTH, H - botY);
            // Bottom pipe cap
            ctx.fillStyle = '#22c55e';
            ctx.fillRect(pipe.x - 4, botY, PIPE_WIDTH + 8, 16);
            ctx.strokeStyle = '#15803d';
            ctx.strokeRect(pipe.x - 4, botY, PIPE_WIDTH + 8, 16);
        }

        // Bird body
        ctx.save();
        ctx.translate(birdX, birdY);
        const angle = Math.min(Math.max(birdVel * 3, -30), 60) * Math.PI / 180;
        ctx.rotate(angle);

        // Body
        ctx.fillStyle = '#06b6d4';
        ctx.beginPath();
        ctx.ellipse(0, 0, birdRadius + 2, birdRadius, 0, 0, Math.PI * 2);
        ctx.fill();

        // Wing
        ctx.fillStyle = '#0891b2';
        ctx.beginPath();
        const wingY = Math.sin(Date.now() / 80) * 3;
        ctx.ellipse(-4, wingY, 8, 5, -0.3, 0, Math.PI * 2);
        ctx.fill();

        // Eye
        ctx.fillStyle = 'white';
        ctx.beginPath();
        ctx.arc(6, -4, 4.5, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#0f172a';
        ctx.beginPath();
        ctx.arc(7.5, -3.5, 2.2, 0, Math.PI * 2);
        ctx.fill();

        // Beak
        ctx.fillStyle = '#f59e0b';
        ctx.beginPath();
        ctx.moveTo(12, -1);
        ctx.lineTo(20, 1);
        ctx.lineTo(12, 4);
        ctx.closePath();
        ctx.fill();

        ctx.restore();

        // Ground
        ctx.fillStyle = '#22c55e';
        ctx.fillRect(0, H - 4, W, 4);
    }

    function loop() {
        if (!gameRunning) return;
        update();
        if (!gameRunning) return;
        draw();
        animFrame = requestAnimationFrame(loop);
    }

    function gameOver() {
        gameRunning = false;
        if (animFrame) cancelAnimationFrame(animFrame);
        document.getElementById('final-score').textContent = score;
        document.getElementById('game-over').classList.remove('hidden');
    }

    function startGame() {
        document.getElementById('start-screen').classList.add('hidden');
        init();
        gameRunning = true;
        draw();
        animFrame = requestAnimationFrame(loop);
    }

    function resetGame() {
        document.getElementById('game-over').classList.add('hidden');
        init();
        gameRunning = true;
        draw();
        animFrame = requestAnimationFrame(loop);
    }

    // Input
    document.addEventListener('keydown', e => {
        if (e.code === 'Space' || e.key === ' ') { flap(); e.preventDefault(); }
    });
    canvas.addEventListener('click', flap);
    canvas.addEventListener('touchstart', e => { flap(); e.preventDefault(); });

    // Initial draw
    init();
    draw();

</script>
</body>
</html>

