<!DOCTYPE html>

<html class="h-full" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Lesson 6.1: Chemical Equations  Conservation of Mass</title>
<script src="/_sdk/element_sdk.js"></script>
<script src="/global_translations.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&amp;display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="/ArisEdu Project Folder/styles/main.css">
<style>@view-transition { navigation: auto; }
    /* Embedded Summary Styles - Injected for Layout Fixes */
    .lesson-notes {
      margin-top: 1.5rem;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 1rem;
      padding: 1.5rem 1.75rem;
      box-shadow: 0 10px 18px rgba(15, 23, 42, 0.12);
      color: #0f172a;
    }

    .lesson-notes h3 {
      font-size: 1.2rem;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 0.5rem;
    }

    .lesson-notes p {
      margin-bottom: 1rem;
      color: #1e293b;
    }

    .lesson-notes ul {
      margin: 0 0 1.25rem 1.25rem;
      color: #1e293b;
      list-style: disc;
    }

    .lesson-notes li {
      margin-bottom: 0.35rem;
    }
    
    .diagram-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      margin-top: 1.5rem;
      position: relative;
    }

    body.dark-mode .lesson-notes {
      background: #0f172a;
      border: 1px solid #1e293b;
      box-shadow: 0 10px 18px rgba(2, 6, 23, 0.35);
      color: #e2e8f0;
    }

    body.dark-mode .lesson-notes h3 {
      color: #f8fafc;
    }

    body.dark-mode .lesson-notes p,
    body.dark-mode .lesson-notes ul {
      color: #e2e8f0;
    }

    body.dark-mode .diagram-card {
      background: rgba(15, 23, 42, 0.85);
    }
    
    .diagram-placeholder {
      border: 2px dashed rgba(59, 130, 246, 0.6);
      border-radius: 0.75rem;
      padding: 2.5rem;
      text-align: center;
      color: #475569;
    }

    body.dark-mode .diagram-placeholder {
      color: #cbd5e1;
      border-color: rgba(148, 163, 184, 0.6);
    }
    
    /* Ensures Next Up: Play button is aligned to bottom right */
    .summary-actions {
      margin-top: 1.5rem;
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    

</style>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&amp;display=swap" rel="stylesheet"/>
<style>
/* Quiz View Styles */
#quiz-content-view .quiz-container {
    padding: 2rem;
    width: 100%;
    height: 75vh;
    overflow-y: auto;
}
#quiz-content-view .quiz-question {
    background: rgba(255, 255, 255, 0.05);
    padding: 1.5rem;
    border-radius: 0.5rem;
    border: 1px solid rgba(0,0,0,0.1);
}
body.dark-mode #quiz-content-view .quiz-question {
    background: rgba(0, 0, 0, 0.2);
    border-color: rgba(255,255,255,0.1);
}
#quiz-content-view .attempts-indicator {
    font-size: 0.9rem;
    color: #64748b;
    margin-bottom: 0.5rem;
    font-style: italic;
}
</style>
<script src="../../theme_manager.js"></script>
</head>
<body class="dark-mode h-full">
<script src="../../scripts/taskbar.js"></script>
<main class="main-container">
<h2 class="page-title">Lesson 6.1: Types of Reactions</h2>
<div class="courses-container">
<div class="lesson-layout">
<div class="video-embed">
<iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen="" referrerpolicy="strict-origin-when-cross-origin" src="https://www.youtube.com/" title="Lesson 6.1 videos placeholder"></iframe>
</div>
<div class="side-buttons">
<button class="side-button view-other-videos" onclick="toggleVideosPanel(this)" type="button">View other videos</button>
<div aria-hidden="true" class="videos-panel">
<div class="videos-panel-title">Lesson 6.1 videos</div>
<div class="videos-panel-item">
<a data-video-src="" data-video-title="Video 1" href="#">Video 1</a>
<div aria-hidden="true" class="mini-rubric">
<span style="background:#ccc"></span>
<span style="background:#ccc"></span>
<span style="background:#ccc"></span>
<span style="background:#ccc"></span>
</div>
</div>
<div class="videos-panel-item">
<a data-video-src="" data-video-title="Video 2" href="#">Video 2</a>
<div aria-hidden="true" class="mini-rubric">
<span style="background:#ccc"></span>
<span style="background:#ccc"></span>
<span style="background:#ccc"></span>
<span style="background:#ccc"></span>
</div>
</div>
<div class="videos-panel-item">
<a data-video-src="" data-video-title="Video 3" href="#">Video 3</a>
<div aria-hidden="true" class="mini-rubric">
<span style="background:#ccc"></span>
<span style="background:#ccc"></span>
<span style="background:#ccc"></span>
<span style="background:#ccc"></span>
</div>
</div>
<div class="videos-panel-item">
<a data-video-src="" data-video-title="Video 4" href="#">Video 4</a>
<div aria-hidden="true" class="mini-rubric">
<span style="background:#ccc"></span>
<span style="background:#ccc"></span>
<span style="background:#ccc"></span>
<span style="background:#ccc"></span>
</div>
</div>
<div class="videos-panel-item">
<a data-video-src="" data-video-title="Video 5" href="#">Video 5</a>
<div aria-hidden="true" class="mini-rubric">
<span style="background:#ccc"></span>
<span style="background:#ccc"></span>
<span style="background:#ccc"></span>
<span style="background:#ccc"></span>
</div>
</div>
</div>
<a class="side-button" href="Lesson 6.1 Chemical_Equations__Conservation_of_Mass Summary.html">Next Up: Summary</a>
</div>
</div>
<div class="rubric-box">
<div class="rubric-hover-wrap">
<div aria-hidden="true" class="rubric-hover-dot"><span>i</span></div>
<div aria-hidden="true" class="rubric-hover-panel">
<p><strong>Difficulty:</strong> How hard topic is &amp; how well they explained it</p>
<p><strong>Detail:</strong> Depth of content covered</p>
<p><strong>Speed:</strong> How long the video is</p>
<p><strong>Pace:</strong> How fast the video runs</p>
</div>
</div>
<h2 class="page-title">Rubric</h2>
<div class="rubric-card">
<div class="rubric-grid">
<div class="rubric-item" style="background:#e2e8f0">
<div class="rubric-text">
<span class="rubric-label">Difficulty</span>
<span class="rubric-rating">TBD</span>
</div>
</div>
<div class="rubric-item" style="background:#e2e8f0">
<div class="rubric-text">
<span class="rubric-label">Detail</span>
<span class="rubric-rating">TBD</span>
</div>
</div>
<div class="rubric-item" style="background:#e2e8f0">
<div class="rubric-text">
<span class="rubric-label">Speed</span>
<span class="rubric-rating">TBD</span>
</div>
</div>
<div class="rubric-item" style="background:#e2e8f0">
<div class="rubric-text">
<span class="rubric-label">Pace</span>
<span class="rubric-rating">TBD</span>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- Quiz View (Hidden by default) -->
<div id="quiz-content-view" style="display: none;">
<h2 class="page-title">Lesson 6.1: Quiz</h2>
<div class="diagram-card">
<div class="quiz-container">
<form id="quiz-form">

            <div class="quiz-question" style="margin-bottom: 2rem;" data-attempts="2">
                <p style="font-weight: 700; font-size: 1.1rem; margin-bottom: 1rem;">1. What is the main definition of Types of Reactions?</p>
                <label style="display:block;margin-bottom:0.5rem;cursor:pointer;"><input type="radio" name="q1" value="correct"> It describes the fundamental principles of Types of Reactions.</label>
                <label style="display:block;margin-bottom:0.5rem;cursor:pointer;"><input type="radio" name="q1" value="wrong1"> It is unrelated to chemistry.</label>
                <label style="display:block;margin-bottom:0.5rem;cursor:pointer;"><input type="radio" name="q1" value="wrong2"> It only applies to noble gases.</label>
                <label style="display:block;margin-bottom:0.5rem;cursor:pointer;"><input type="radio" name="q1" value="wrong3"> It was discovered in 2025.</label>
                <div class="attempts-indicator"></div>
                <div style="margin-top:1rem;">
                    <button type="button" class="action-button" onclick="window.checkQuizAnswer('q1', 'correct', this)">Submit Answer</button>
                    <button type="button" class="nav-button" onclick="const p=this.closest('.quiz-question'); const f=p.querySelector('.feedback'); if(f)f.remove(); p.querySelectorAll('input').forEach(i=>i.disabled=false); p.dataset.status='';" style="margin-left:0.5rem;">Try Again</button>
                </div>
            </div>
            
            <div class="quiz-question" style="margin-bottom: 2rem;" data-attempts="2">
                <p style="font-weight: 700; font-size: 1.1rem; margin-bottom: 1rem;">2. Why is Types of Reactions important in this unit?</p>
                <label style="display:block;margin-bottom:0.5rem;cursor:pointer;"><input type="radio" name="q2" value="wrong1"> It has no practical application.</label>
                <label style="display:block;margin-bottom:0.5rem;cursor:pointer;"><input type="radio" name="q2" value="correct"> It helps predict chemical behavior and properties.</label>
                <label style="display:block;margin-bottom:0.5rem;cursor:pointer;"><input type="radio" name="q2" value="wrong2"> It creates energy from nothing.</label>
                <label style="display:block;margin-bottom:0.5rem;cursor:pointer;"><input type="radio" name="q2" value="wrong3"> It is only used in physics.</label>
                <div class="attempts-indicator"></div>
                <div style="margin-top:1rem;">
                    <button type="button" class="action-button" onclick="window.checkQuizAnswer('q2', 'correct', this)">Submit Answer</button>
                    <button type="button" class="nav-button" onclick="const p=this.closest('.quiz-question'); const f=p.querySelector('.feedback'); if(f)f.remove(); p.querySelectorAll('input').forEach(i=>i.disabled=false); p.dataset.status='';" style="margin-left:0.5rem;">Try Again</button>
                </div>
            </div>
            
</form>
<div id="quiz-results" style="margin-top: 2rem; font-weight: bold; display:none; padding: 1rem; border-radius: 0.5rem;"></div>
</div>
</div>
</div>
</main>
<script>

    function toggleVideosPanel(button) {
      if (!button) {
        return;
      }
      const panel = button.parentElement.querySelector('.videos-panel');
      if (!panel) {
        return;
      }
      const isOpen = panel.classList.toggle('is-open');
      panel.style.display = isOpen ? 'block' : 'none';
      panel.setAttribute('aria-hidden', (!isOpen).toString());
    }

    document.querySelectorAll('.videos-panel a[data-video-id], .videos-panel a[data-video-src]').forEach((link) => {
      link.addEventListener('click', (event) => {
        event.preventDefault();
        const videoSrc = link.getAttribute('data-video-src');
        const videoId = link.getAttribute('data-video-id');
        const videoTitle = link.getAttribute('data-video-title') || 'Lesson video';
        const iframe = document.querySelector('.video-embed iframe');
        const nextSrc = videoSrc || (videoId ? `https://www.youtube.com/embed/${videoId}` : '');
        if (!nextSrc || !iframe) {
          return;
        }
        iframe.src = nextSrc;
        iframe.title = videoTitle;

        const panel = link.closest('.videos-panel');
        const container = link.closest('.side-buttons');
        if (panel) {
          panel.classList.remove('is-open');
          panel.setAttribute('aria-hidden', 'true');
        }
        if (container) {
          container.classList.remove('videos-open');
        }
      });

    });

    // videos-panel overrides
    function updateRubricFromLink(link) {
      if (!link) {
        return;
      }
      const rubricBox = document.querySelector('.rubric-box');
      if (!rubricBox) {
        return;
      }
      const keyMap = {
        Difficulty: 'difficulty',
        Detail: 'detail',
        Speed: 'speed',
        Pace: 'pace',
      };
      rubricBox.querySelectorAll('.rubric-item').forEach((item) => {
        const labelEl = item.querySelector('.rubric-label');
        const ratingEl = item.querySelector('.rubric-rating');
        if (!labelEl || !ratingEl) {
          return;
        }
        const label = labelEl.textContent.trim();
        const key = keyMap[label];
        if (!key) {
          return;
        }
        const rating = link.getAttribute(`data-rating-${key}`) || label;
        const color = link.getAttribute(`data-color-${key}`) || '#334155';
        ratingEl.textContent = rating;
        item.style.background = color;
      });
    }

    function toggleVideosPanel(button) {
      if (!button) {
        return;
      }
      const container = button.closest('.side-buttons');
      if (!container) {
        return;
      }
      const panel = container.querySelector('.videos-panel');
      if (!panel) {
        return;
      }
      const isOpen = panel.classList.toggle('is-open');
      container.classList.toggle('videos-open', isOpen);
      panel.setAttribute('aria-hidden', (!isOpen).toString());
    }

    document.querySelectorAll('.view-other-videos').forEach((button) => {
      button.addEventListener('click', (event) => {
        event.preventDefault();
        toggleVideosPanel(button);
      });
    });

    document.addEventListener('click', (event) => {
      const button = event.target.closest('.view-other-videos');
      if (!button) {
        return;
      }
      event.preventDefault();
      toggleVideosPanel(button);
    }, true);

    document.querySelectorAll('.videos-panel a').forEach((link) => {
      link.addEventListener('click', (event) => {
        event.preventDefault();
        const videoSrc = link.getAttribute('data-video-src');
        const videoId = link.getAttribute('data-video-id');
        const videoTitle = link.getAttribute('data-video-title') || 'Lesson video';
        const iframe = document.querySelector('.video-embed iframe');
        const nextSrc = videoSrc || (videoId ? `https://www.youtube.com/embed/${videoId}` : '');
        if (!nextSrc || !iframe) {
          updateRubricFromLink(link);
          return;
        }
        iframe.src = nextSrc;
        iframe.title = videoTitle;
        updateRubricFromLink(link);

        const panel = link.closest('.videos-panel');
        const container = link.closest('.side-buttons');
        if (panel) {
          panel.classList.remove('is-open');
          panel.setAttribute('aria-hidden', 'true');
        }
        if (container) {
          container.classList.remove('videos-open');
        }
      });
    });

  </script>
<script>
  window.togglePracticesPanel = function(button) {
    if (!button) return;
    const menu = button.closest('.Practices-menu') || button.closest('.side-buttons'); 
    if (!menu) return;
    const panel = menu.querySelector('.Practices-panel');
    if (!panel) return;
    const isOpen = panel.classList.toggle('is-open');
    panel.setAttribute('aria-hidden', (!isOpen).toString());
  };
    
  // Ensure listeners are attached if not using inline onclick
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.view-other-Practices').forEach((button) => {
      button.addEventListener('click', (event) => {
        event.preventDefault();
        window.togglePracticesPanel(button);
      });
    });
  });
</script>
<script>
  window.switchToClimb = function() {
    // Hide all games first
    ['flashcard-game', 'climb-game-container', 'mixmatch-container', 'blockpuzzle-container'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.style.display = 'none';
    });
    const climbGame = document.getElementById('climb-game-container');
    if(climbGame) { climbGame.style.display = 'block'; if(window.initClimbGame) window.initClimbGame(); }
  };

  window.switchToFlashcards = function() {
    // Hide all games first
    ['flashcard-game', 'climb-game-container', 'mixmatch-container', 'blockpuzzle-container'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.style.display = 'none';
    });
    const flashcardGame = document.querySelector('.flashcard-game');
    if(flashcardGame) flashcardGame.style.display = 'flex';
    if(typeof window.initFlashcards === 'function') window.initFlashcards();
  };

  document.addEventListener('DOMContentLoaded', () => {
    // Attach listeners to practice menu items
    
    // Climb Link
    document.querySelectorAll('a[href="#climb"]').forEach(el => {
      el.addEventListener('click', (e) => {
        e.preventDefault();
        window.switchToClimb();
        // Close menu if possible
        if (window.togglePracticesPanel && el.closest('.Practices-menu')) {
             const btn = el.closest('.Practices-menu').querySelector('.view-other-Practices');
             if(btn) window.togglePracticesPanel(btn);
        }
      });
    });

    // Flashcard Link
    document.querySelectorAll('a[href="#flashcard-game"]').forEach(el => {
      el.addEventListener('click', (e) => {
        e.preventDefault();
        window.switchToFlashcards();
        // Close menu if possible
         if (window.togglePracticesPanel && el.closest('.Practices-menu')) {
             const btn = el.closest('.Practices-menu').querySelector('.view-other-Practices');
             if(btn) window.togglePracticesPanel(btn);
        }
      });
    });
  });
</script>
<script>
// Climb Game Logic
(function() {
    let climbScore = 0;
    
    let playerPosition = 35; // percent from bottom
    let isGameRunning = false; let isPaused = false; let spacePressed = false;
    let gameLoopId = null;
    let currentQuestion = null;
    document.addEventListener('keydown', (e) => { if(e.code === 'Space') { spacePressed = true; if(isGameRunning) e.preventDefault(); } });
    document.addEventListener('keyup', (e) => { if(e.code === 'Space') spacePressed = false; });
    let climbFuel = 50; let downwardAccel = 0;
    
    // Config
    const WIN_HEIGHT = 90; // percent
    const CLIMB_STEP = 15; // percent
    const FALL_RATE = 0.04; // percent per tick (simulates moving ladder)
    const TICK_RATE = 20; // ms
    
    window.initClimbGame = function() {
    const bg = document.getElementById('climb-stars');
    if(bg && bg.innerHTML === '') {
        for(let i=0; i<60; i++) {
            const m = document.createElement('div');
            m.style.position = 'absolute';
            m.style.left = Math.random()*100 + '%';
            m.style.top = Math.random()*100 + '%';
            const size = Math.random()*2 + 1;
            m.style.width = size + 'px';
            m.style.height = size + 'px';
            m.style.background = '#fff';
            m.style.borderRadius = '50%';
            m.style.opacity = Math.random()*0.7 + 0.3;
            m.style.animation = `twinkle ${Math.random()*4+2}s infinite alternate ease-in-out`;
            bg.appendChild(m);
        }
    }

        const ui = document.getElementById('climb-game-ui');
        if(ui) ui.style.display = 'flex';
    }

    window.toggleClimbFullscreen = function() {
        const elem = document.getElementById('climb-game-ui');
        if (!document.fullscreenElement) {
            if (elem.requestFullscreen) {
                elem.requestFullscreen().catch(err => {
                    console.error(`Error attempting to enable fullscreen: ${err.message}`);
                });
            } else if (elem.webkitRequestFullscreen) { /* Safari */
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) { /* IE11 */
                elem.msRequestFullscreen();
            }
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) { /* Safari */
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) { /* IE11 */
                document.msExitFullscreen();
            }
        }
    };
window.exitClimbGame = function() {
        const ui = document.getElementById('climb-game-ui');
        if(ui) ui.style.display = 'none';
        isGameRunning = false;
        if(gameLoopId) clearInterval(gameLoopId);
        window.switchToFlashcards();
    }

    window.toggleClimbPause = function() {
        if (!isGameRunning && !isPaused) return;
        isPaused = !isPaused;
        const btn = document.getElementById('climb-pause-btn');
        if (btn) btn.innerText = isPaused ? "Resume" : "Pause";
        
        const pauseScreen = document.getElementById('climb-paused-screen');
        if(pauseScreen) pauseScreen.style.display = isPaused ? 'flex' : 'none';
    };

    window.resetToClimbMenu = function() {
        isGameRunning = false;
        isPaused = false;
        if(gameLoopId) clearInterval(gameLoopId);
        
        document.getElementById('climb-game-ui').style.display = 'flex';
        document.getElementById('climb-start-screen').style.display = 'flex';
        document.getElementById('climb-game-over').style.display = 'none';
        document.getElementById('climb-interaction').style.display = 'none';
        
        const pauseScreen = document.getElementById('climb-paused-screen');
        if(pauseScreen) pauseScreen.style.display = 'none';
        
        const pBtn = document.getElementById('climb-pause-btn');
        if(pBtn) pBtn.innerText = "Pause";
        
        const interaction = document.getElementById('climb-interaction');
        if (interaction) interaction.style.opacity = "1";
    }

    window.startClimbGame = function() {
        isPaused = false;
        const pBtn = document.getElementById('climb-pause-btn');
        if(pBtn) pBtn.innerText = "Pause";
        const interaction = document.getElementById('climb-interaction');
        if (interaction) interaction.style.opacity = "1";

        // Reset State
        climbScore = 0;
        climbFuel = 50;
        
        playerPosition = 35;
        isGameRunning = true;
        
        document.getElementById('climb-start-screen').style.display = 'none';
        document.getElementById('climb-game-over').style.display = 'none';
        document.getElementById('climb-question-area').style.display = 'block';
        
        updateDisplay();
        nextClimbQuestion();
        
        // Start "Ladder Going Down" Mechanics
        if(gameLoopId) clearInterval(gameLoopId);
        gameLoopId = setInterval(gameLoop, TICK_RATE);
    }
    
    function gameLoop() {
        if(!isGameRunning || isPaused) return;
        
        const isBoosting = spacePressed && climbFuel > 0;
        if(isBoosting) {
            playerPosition = Math.min(95, playerPosition + 0.5);
            climbFuel = Math.max(0, climbFuel - 0.2);
            if(typeof updateFuelDisplay === 'function') updateFuelDisplay();
        }
        
        // Visual Boost Effect
        const fOut = document.getElementById('climb-flame-outer');
        const fIn = document.getElementById('climb-flame-inner');
        if(fOut && fIn) {
            const scale = isBoosting ? "scale(1.2, 2.0)" : "scale(1, 1)";
            fOut.style.transform = scale;
            fIn.style.transform = scale;
        }

        // Ladder moves down, so character moves down relative to viewport if they don't climb
        // Or simply: Gravity pulls them down
        let effectiveFall = FALL_RATE;
        if (climbFuel <= 0) {
            downwardAccel += 0.007;
            effectiveFall += downwardAccel;
        } else {
            downwardAccel = 0;
        }
        playerPosition -= effectiveFall;
        climbFuel = Math.max(0, climbFuel - 0.1); // Faster at higher levels?
        
        if (playerPosition <= 0) {
            endGame();
        }
        
        updatePlayerPos();
        updateFuelDisplay();
    }
    
    function updateDisplay() {
        document.getElementById('climb-score').innerText = `Score: ${climbScore}`;
        
        updatePlayerPos();
        updateFuelDisplay();
    }
    
        function updateFuelDisplay() {
        const fill = document.getElementById('climb-fuel-fill');
        if(fill) fill.style.height = `${climbFuel}%`;
    }
    
    function updatePlayerPos() {
        const player = document.getElementById('climb-player');
        if(player) player.style.bottom = `${Math.max(0, playerPosition)}%`;
    }
    
    function nextClimbQuestion() {
        const feedback = document.getElementById('climb-feedback');
        feedback.innerText = '';
        feedback.className = '';
        
        if (!window.lessonFlashcards || window.lessonFlashcards.length === 0) {
            document.getElementById('climb-question-text').innerText = "No flashcards found for this lesson!";
            return;
        }
        
        // Pick random question
            // Unique Question Logic
    if (!window.usedFlashcardIndices) window.usedFlashcardIndices = [];
    
    // Safety check for flashcards
    if (!window.lessonFlashcards) {
        if (typeof window.initFlashcards === 'function') window.initFlashcards();
    }
    
    // Filter available indices
    let availablePool = [];
    if (window.lessonFlashcards) {
        availablePool = window.lessonFlashcards
            .map((_, i) => i)
            .filter(i => !window.usedFlashcardIndices.includes(i));
    }
    
    let qIdx;
    if (availablePool.length > 0) {
        const randomPoolIdx = Math.floor(Math.random() * availablePool.length);
        qIdx = availablePool[randomPoolIdx];
    } else {
        // Reset if exhausted to avoid infinite loops or empty
        window.usedFlashcardIndices = [];
        qIdx = Math.floor(Math.random() * (window.lessonFlashcards ? window.lessonFlashcards.length : 0));
    }
    window.usedFlashcardIndices.push(qIdx);
        currentQuestion = window.lessonFlashcards[qIdx];
        
        document.getElementById('climb-question-text').innerText = currentQuestion.question;
        
        // Generate Distractors
        const options = [currentQuestion.answer];
        const uniqueOptions = new Set([currentQuestion.answer]);
        
        // Try to get 2 unique distractors (or fewer if not enough unique answers exist)
        const allAnswers = window.lessonFlashcards.map(f => f.answer);
        // Shuffle all answers first to ensure randomness in selection
        for (let i = allAnswers.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [allAnswers[i], allAnswers[j]] = [allAnswers[j], allAnswers[i]];
        }
        
        for(let ans of allAnswers) {
            if(!uniqueOptions.has(ans)) {
                options.push(ans);
                uniqueOptions.add(ans);
                if(options.length >= 3) break; // 1 correct + 2 distractors
            }
        }
        
        // Shuffle Options
        for (let i = options.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [options[i], options[j]] = [options[j], options[i]];
        }
        
        // Render Options
        const optionsContainer = document.getElementById('climb-options');
        optionsContainer.innerHTML = '';
        
        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'climb-option-btn';
            btn.innerText = opt;
            btn.onclick = () => handleClimbAnswer(opt);
            optionsContainer.appendChild(btn);
        });
    }
    
    function handleClimbAnswer(selected) { if(isPaused) return;
        if(!isGameRunning || isPaused) return;
        
        const isBoosting = spacePressed && climbFuel > 0;
        if(isBoosting) {
            playerPosition = Math.min(95, playerPosition + 0.5);
            climbFuel = Math.max(0, climbFuel - 0.2);
            if(typeof updateFuelDisplay === 'function') updateFuelDisplay();
        }
        
        // Visual Boost Effect
        const fOut = document.getElementById('climb-flame-outer');
        const fIn = document.getElementById('climb-flame-inner');
        if(fOut && fIn) {
            const scale = isBoosting ? "scale(1.2, 2.0)" : "scale(1, 1)";
            fOut.style.transform = scale;
            fIn.style.transform = scale;
        }

        const feedback = document.getElementById('climb-feedback');
        
        if(selected === currentQuestion.answer) {
            // Correct
            climbScore += 10;
            climbFuel = Math.min(100, climbFuel + 20);
            // playerPosition += CLIMB_STEP; // Disabled for manual boost
            feedback.innerText = "Correct! Adding fuel...";
            feedback.style.color = "#16a34a";

        } else {
            // Incorrect
            playerPosition -= 5; // Slip down
            feedback.innerText = "Oops! Slipping down...";
            feedback.style.color = "#dc2626";
        }
        
        updateDisplay();
        
        // Disable buttons temporarily
        const btns = document.querySelectorAll('.climb-option-btn');
        btns.forEach(b => b.disabled = true);
        
        setTimeout(() => {
            nextClimbQuestion();
        }, 1000);
    }
    
        function endGame() {
        isGameRunning = false;
        clearInterval(gameLoopId);
        
        document.getElementById('climb-question-area').style.display = 'none';
        document.getElementById('climb-interaction').style.display = 'none';
        const gameOverScreen = document.getElementById('climb-game-over');
        gameOverScreen.style.display = 'flex';
        
        const title = document.getElementById('climb-result-title');
        const msg = document.getElementById('climb-final-score');
        
        // High Score Logic
        let storageKey = 'climbHighScore';
        try {
            const currentUser = JSON.parse(localStorage.getItem('user'));
            if(currentUser && currentUser.email) {
                storageKey = 'climbHighScore_' + currentUser.email;
            }
        } catch(e) { console.error(e); }

        let highScore = localStorage.getItem(storageKey) || 0;
        highScore = parseInt(highScore);
        if(climbScore > highScore) {
            highScore = climbScore;
            localStorage.setItem(storageKey, highScore);
            title.innerText = "üèÜ New High Score! üèÜ";
            title.style.color = "#f59e0b";
        } else {
            title.innerText = "Game Over";
            title.style.color = "#1e293b";
        }
        
        msg.innerHTML = `Score: ${climbScore}<br><span style="font-size:0.9em; color:#64748b">Best: ${highScore}</span>`;
    }
})();
</script>
<!-- ArisEdu Global Search -->
<script src="../../../search_data.js"></script>
<script src="../../../search_logic.js"></script>
<script>
  // Quiz Feature Logic
  window.quizInitialized = false;

  window.randomizeQuizQuestions = function() {
    const form = document.getElementById('quiz-form');
    if (!form) return;
    
    // Collect questions
    let questions = Array.from(form.querySelectorAll('.quiz-question'));
    if (questions.length === 0) return;
    
    // If we already have 5 or less, we might not need to do anything, 
    // UNLESS we want to shuffle static ones.
    // If dataset.shuffled is true, skip.
    if (form.dataset.shuffled === 'true') return;

    // Shuffle
    for (let i = questions.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [questions[i], questions[j]] = [questions[j], questions[i]];
    }

    // Limit to 5
    const selected = questions.slice(0, 5);
    
    // Clear and Append
    form.innerHTML = '';
    selected.forEach((q, index) => {
        // Fix Numbering
        const p = q.querySelector('p');
        if (p) {
            p.textContent = p.textContent.replace(/^\d+\.\s*/, `${index + 1}. `);
        }
        form.appendChild(q);
    });
    
    form.dataset.shuffled = 'true';
  };

  window.toggleToQuiz = function(event) {
    window.usedFlashcardIndices = [];
    if (event) event.preventDefault();
    const lessonView = document.getElementById('lesson-content-view');
    const practiceView = document.getElementById('practice-content-view');
    const summaryView = document.getElementById('summary-content-view');
    const quizView = document.getElementById('quiz-content-view');
    
    if (lessonView) lessonView.style.display = 'none';
    if (practiceView) practiceView.style.display = 'none';
    if (summaryView) summaryView.style.display = 'none';
    if (quizView) quizView.style.display = 'none';
    if (quizView) quizView.style.display = 'block';
    
    // Auto-populate if not initialized
    if (!window.quizInitialized) {
        window.populateInitialQuiz();
        window.quizInitialized = true;
    }

    // Update Back Button
    const backBtn = document.getElementById('back-button');
    if (backBtn) {
        backBtn.innerText = "‚Üê Back to Practice";
        const newBackBtn = backBtn.cloneNode(true);
        if (backBtn.parentNode) {
            backBtn.parentNode.replaceChild(newBackBtn, backBtn);
            newBackBtn.addEventListener('click', (e) => {
                e.preventDefault();
                window.toggleToPractice(e);
            });
        }
    }
    if(window.randomizeQuizQuestions) window.randomizeQuizQuestions();
    window.scrollTo(0, 0);
  };

  window.populateInitialQuiz = function() {
      // If flashcards aren't ready, try init
      if ((!window.lessonFlashcards || window.lessonFlashcards.length === 0) && typeof window.initFlashcards === 'function') {
          window.initFlashcards();
      }
      
      const form = document.getElementById('quiz-form');
      if (!form) return;
      if (!window.lessonFlashcards || window.lessonFlashcards.length === 0) {
          form.innerHTML = '<p>No quiz questions available for this lesson yet.</p>';
          return;
      }

      form.innerHTML = ''; // Clear template

      // Generate 10 questions (or max available)
      for (let i = 1; i <= 5 ; i++) {
          const wrapper = document.createElement('div');
          wrapper.className = 'quiz-question';
          wrapper.style.marginBottom = '2rem';
          wrapper.dataset.attempts = '2';
          
          wrapper.innerHTML = `
            <div class="attempts-indicator">Attempts left: 2</div>
            <p style="font-weight: 700; font-size: 1.1rem; margin-bottom: 1rem;">${i}. Loading...</p>
            <button type="button" class="side-button" style="margin-top:0.5rem; font-size:1rem; padding:0.5rem 1rem; min-width:auto;" onclick="checkQuizAnswer(null, null, this)">Check Answer</button>
            <button type="button" class="side-button" style="margin-top:0.5rem; font-size:1rem; padding:0.5rem 1rem; min-width:auto; margin-left:0.5rem; background: #64748b;" onclick="getAnotherQuestion(this)">Get another question</button>
          `;
          
          form.appendChild(wrapper);
          // Use getAnotherQuestion logic to fill it
          // We pass the "Get another" button to the function to simulate a click
          window.getAnotherQuestion(wrapper.querySelector('button:last-of-type'), i); 
      }
  };

  window.checkQuizAnswer = function(name, correct, btn) {
    const parent = btn.closest('.quiz-question');
    if(!parent) return;

    // Get or Init Attempts
    let attemptsElem = parent.querySelector('.attempts-indicator');
    if (!attemptsElem) return;
    
    let attempts = parseInt(parent.dataset.attempts || '2');

    // Dynamically find name if not passed (for re-generated questions)
    if (!name) {
        const input = parent.querySelector('input[type="radio"]');
        if (input) name = input.name;
    }

    const selected = parent.querySelector(`input[name="${name}"]:checked`);
    
    let feedback = parent.querySelector('.feedback');
    if(!feedback) {
        feedback = document.createElement('div');
        feedback.className = 'feedback';
        feedback.style.marginTop = '1rem';
        feedback.style.fontWeight = 'bold';
        feedback.style.padding = '0.5rem';
        feedback.style.borderRadius = '0.5rem';
        parent.appendChild(feedback);
    }
    
    if (!selected) {
        feedback.textContent = "Please select an answer first.";
        feedback.style.color = "#ea580c";
        feedback.style.background = "#fff7ed";
        return;
    }
    
    // Detect correct answer from value if checking against 'correct' param is complex
    // But our generation logic embeds the correct letter in the onclick.
    // However, for the initial load, I need to make sure the onclick is updated correctly.

    if (attempts <= 0 || btn.disabled) return;
    
    // If correct is null, try to retrieve it from the button's onclick attribute or dataset
    if (!correct) {
       // This is a fallback if the inline handler didn't have it
       // But getAnotherQuestion updates the handler.
    }
    
    if (selected.value === correct) {
        feedback.textContent = "Correct! Great job.";
        feedback.style.color = "#16a34a"; 
        feedback.style.background = "#dcfce7";
        btn.disabled = true;
        const inputs = parent.querySelectorAll('input');
        inputs.forEach(i => i.disabled = true);
        attemptsElem.style.display = 'none';
    } else {
        attempts--;
        parent.dataset.attempts = attempts;
        attemptsElem.textContent = `Attempts left: ${attempts}`;

        if (attempts <= 0) {
             feedback.textContent = `Incorrect. The correct answer was option ${correct.toUpperCase()}.`;
             feedback.style.color = "#dc2626";
             feedback.style.background = "#fee2e2";
             btn.disabled = true;
             const inputs = parent.querySelectorAll('input');
             inputs.forEach(i => i.disabled = true);
        } else {
             feedback.textContent = "Incorrect. Try again!";
             feedback.style.color = "#dc2626";
             feedback.style.background = "#fee2e2";
        }
    }
  };

  window.getAnotherQuestion = function(btn, forceNum) {
    if ((!window.lessonFlashcards || window.lessonFlashcards.length === 0) && typeof window.initFlashcards === 'function') {
        window.initFlashcards();
    }
    if (!window.lessonFlashcards || window.lessonFlashcards.length === 0) {
        // console.log("No flashcards");
        return;
    }

    const parent = btn.closest('.quiz-question');
    if(!parent) return;
    
    // Cleanup old feedback
    const feedback = parent.querySelector('.feedback');
    if(feedback) feedback.remove();
    const oldLabels = parent.querySelectorAll('label');
    oldLabels.forEach(l => l.remove());
    
    // Reset attempts
    const attemptsElem = parent.querySelector('.attempts-indicator');
    if(attemptsElem) {
        attemptsElem.textContent = 'Attempts left: 2';
        attemptsElem.style.display = 'block';
    }
    parent.dataset.attempts = '2';
    
    const checkBtn = parent.querySelector('button[onclick^="checkQuizAnswer"]');
    if(checkBtn) checkBtn.disabled = false;

    // 1. Pick Random
        // Unique Question Logic
    if (!window.usedFlashcardIndices) window.usedFlashcardIndices = [];
    
    // Safety check for flashcards
    if (!window.lessonFlashcards) {
        if (typeof window.initFlashcards === 'function') window.initFlashcards();
    }
    
    // Filter available indices
    let availablePool = [];
    if (window.lessonFlashcards) {
        availablePool = window.lessonFlashcards
            .map((_, i) => i)
            .filter(i => !window.usedFlashcardIndices.includes(i));
    }
    
    let qIdx;
    if (availablePool.length > 0) {
        const randomPoolIdx = Math.floor(Math.random() * availablePool.length);
        qIdx = availablePool[randomPoolIdx];
    } else {
        // Reset if exhausted to avoid infinite loops or empty
        window.usedFlashcardIndices = [];
        qIdx = Math.floor(Math.random() * (window.lessonFlashcards ? window.lessonFlashcards.length : 0));
    }
    window.usedFlashcardIndices.push(qIdx);
    const q = window.lessonFlashcards[qIdx];
    
    // 2. Update Question Text
    const p = parent.querySelector('p');
    let numPrefix = "";
    if (forceNum) {
        numPrefix = forceNum + ". ";
    } else {
        const match = p.textContent.match(/^\d+\./);
        if (match) numPrefix = match[0] + " ";
    }
    p.textContent = numPrefix + q.question;

    // 3. Generate Options
    const answers = [q.answer];
    // Filter out current answer to pool distractors
    const pool = window.lessonFlashcards.filter(f => f.answer !== q.answer);
    
    // Shuffle pool
    for (let i = pool.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [pool[i], pool[j]] = [pool[j], pool[i]];
    }
    // Take up to 3 distractors
    pool.slice(0, 3).forEach(c => answers.push(c.answer));
    
    // Shuffle final answers
    for (let i = answers.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [answers[i], answers[j]] = [answers[j], answers[i]];
    }
    
    const letters = ['a', 'b', 'c', 'd'];
    const correctIndex = answers.indexOf(q.answer);
    const correctLetter = letters[correctIndex];
    
    // 4. Create DOM
    const name = 'q_' + Math.random().toString(36).substr(2, 9);
    
    // Insert labels before buttons
    // Find where buttons start (checkBtn or the first button)
    const refNode = checkBtn || btn;

    answers.forEach((ans, i) => {
        const label = document.createElement('label');
        label.style.display = 'block';
        label.style.marginBottom = '0.5rem';
        label.style.cursor = 'pointer';
        label.style.fontSize = '1.1rem'; 
        
        // Input with scaling
        label.innerHTML = `<input type="radio" name="${name}" value="${letters[i]}" style="margin-right:0.75rem; transform: scale(1.3);"> ${ans}`;
        
        parent.insertBefore(label, refNode);
    });

    // 5. Update Check Button
    if (checkBtn) {
        checkBtn.setAttribute('onclick', `checkQuizAnswer('${name}', '${correctLetter}', this)`);
        checkBtn.onclick = function() { window.checkQuizAnswer(name, correctLetter, this); }; // Direct bind for safety
    }
  };
</script>
</body>
</html>
