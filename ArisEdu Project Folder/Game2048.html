<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2048 - Arcade</title>
    <script src="firebase-utils.js"></script>
    <style>
        #game-session-timer {
            font-size: 2.5rem !important;
            font-weight: 700 !important;
        }
    </style>
    <script>
        let timerIntervalId;
        let drainIntervalId;
        
        (async function() {
            await initializeFirebase();
            
            function getUser() {
                return JSON.parse(localStorage.getItem('user') || '{}');
            }
            
            function saveUser(user) {
                localStorage.setItem('user', JSON.stringify(user));
            }

            function showOutOfTokensPopup() {
                clearInterval(timerIntervalId);
                clearInterval(drainIntervalId);
                
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);backdrop-filter:blur(4px);z-index:99999;display:flex;align-items:center;justify-content:center;';
                
                const modal = document.createElement('div');
                modal.style.cssText = 'background:white;border-radius:1rem;padding:2rem;max-width:400px;text-align:center;box-shadow:0 20px 25px rgba(0,0,0,0.3);';
                
                modal.innerHTML = `
                    <div style="font-size:3rem;margin-bottom:1rem;">💸</div>
                    <h2 style="font-size:1.5rem;font-weight:700;margin-bottom:1rem;color:#1e293b;">Out of Tokens!</h2>
                    <p style="margin-bottom:1.5rem;color:#64748b;">Your token balance hit zero.</p>
                    <p style="margin-bottom:1.5rem;color:#94a3b8;font-size:0.85rem;">Earn more tokens by completing lessons and quizzes!</p>
                    <button id="back-to-arcade" style="padding:0.75rem 1.5rem;border-radius:0.5rem;border:none;background:#f59e0b;color:#000;cursor:pointer;font-weight:700;font-size:1rem;">Back to Arcade</button>
                `;
                
                overlay.appendChild(modal);
                document.body.appendChild(overlay);
                
                modal.querySelector('#back-to-arcade').onclick = () => {
                    sessionStorage.removeItem('validGameAccess');
                    window.location.href = 'arcade.html';
                };
            }
            
            window.initializeTokenDrain = function() {
                const sidebar = document.getElementById('game-sidebar');
                if (!sidebar) return;
                
                let timerDisplay = document.getElementById('game-session-timer');
                if (!timerDisplay) {
                    timerDisplay = document.createElement('div');
                    timerDisplay.id = 'game-session-timer';
                    sidebar.appendChild(timerDisplay);
                }

                function updateTimerDisplay() {
                    const user = getUser();
                    const remaining = Math.max(0, user.points || 0);
                    timerDisplay.textContent = remaining + '💎';
                    timerDisplay.className = remaining <= 20 ? 'warning' : '';
                    
                    if (remaining <= 0) {
                        showOutOfTokensPopup();
                    }
                }
                
                function drainTokens() {
                    const user = getUser();
                    const pts = user.points || 0;
                    if (pts > 0) {
                        user.points = pts - 1;
                        saveUser(user);
                        updateTimerDisplay();
                    } else if (pts <= 0) {
                        showOutOfTokensPopup();
                    }
                }
                
                if (timerIntervalId) clearInterval(timerIntervalId);
                if (drainIntervalId) clearInterval(drainIntervalId);
                
                updateTimerDisplay();
                drainIntervalId = setInterval(drainTokens, 1000);
                
                // Pause drain when page is hidden
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        clearInterval(drainIntervalId);
                    } else {
                        drainIntervalId = setInterval(drainTokens, 1000);
                    }
                });
            };
            
            document.addEventListener('DOMContentLoaded', window.initializeTokenDrain);
        })();
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/main.css">
    <style>
        body { font-family: 'Orbitron', monospace; padding-top: 50px; }
        #game-wrapper { margin-left: 150px; width: min(900px, calc(100vw - 360px)); max-width: 100%; }
        #game-sidebar {
            background: rgba(55, 65, 81, 0.98); border-radius: 1rem; padding: 1.5rem;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start; width: 400px;
            min-height: 200px;
            border: 2px solid rgba(107, 114, 128, 0.9);
            box-shadow: 0 20px 45px rgba(0,0,0,0.6);
        }
        .grid-2048 {
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 12px; background: #1a1a1a; padding: 16px; border-radius: 1rem;
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.5), 0 8px 32px rgba(0,0,0,0.3);
            width: 100%; aspect-ratio: 1/1; max-width: 500px; margin: 0 auto;
        }
        .tile {
            min-width: 0; aspect-ratio: 1/1; border-radius: 0.75rem;
            display: flex; align-items: center; justify-content: center;
            font-weight: 900; font-size: 2rem; font-family: 'Orbitron', monospace;
            transition: all 0.15s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1);
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }
        .tile::after {
            content: ''; position: absolute; top: 0; left: 0; right: 50%; bottom: 50%;
            background: linear-gradient(135deg, rgba(255,255,255,0.12) 0%, transparent 100%);
            border-radius: 0.75rem 0 0 0; pointer-events: none;
        }
        .tile:active { transform: scale(0.95); }
        .tile-0    { background: #374151; color: #9ca3af; box-shadow: inset 0 2px 6px rgba(0,0,0,0.4); }
        .tile-0::after { display: none; }
        .tile-2    { background: linear-gradient(135deg, #fcd34d 0%, #fbbf24 50%, #f59e0b 100%); color: #78350f; box-shadow: 0 4px 16px rgba(251, 191, 36, 0.35), inset 0 1px 0 rgba(255,255,255,0.2); }
        .tile-4    { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #f97316 100%); color: #ffffff; box-shadow: 0 4px 16px rgba(245, 158, 11, 0.35), inset 0 1px 0 rgba(255,255,255,0.15); }
        .tile-8    { background: linear-gradient(135deg, #fb923c 0%, #f97316 50%, #ea580c 100%); color: white; box-shadow: 0 4px 16px rgba(249, 115, 22, 0.35), inset 0 1px 0 rgba(255,255,255,0.12); }
        .tile-16   { background: linear-gradient(135deg, #f87171 0%, #ef4444 50%, #dc2626 100%); color: white; box-shadow: 0 4px 16px rgba(239, 68, 68, 0.4), inset 0 1px 0 rgba(255,255,255,0.1); }
        .tile-32   { background: linear-gradient(135deg, #ef4444 0%, #dc2626 50%, #b91c1c 100%); color: white; box-shadow: 0 4px 16px rgba(220, 38, 38, 0.4), inset 0 1px 0 rgba(255,255,255,0.1); }
        .tile-64   { background: linear-gradient(135deg, #dc2626 0%, #b91c1c 50%, #7f1d1d 100%); color: white; box-shadow: 0 6px 20px rgba(185, 28, 28, 0.45), inset 0 1px 0 rgba(255,255,255,0.08); }
        .tile-128  { background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 50%, #7c3aed 100%); color: white; font-size: 1.5rem; box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4), inset 0 1px 0 rgba(255,255,255,0.12); }
        .tile-256  { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 50%, #6d28d9 100%); color: white; font-size: 1.5rem; box-shadow: 0 6px 20px rgba(124, 58, 237, 0.4), inset 0 1px 0 rgba(255,255,255,0.1); }
        .tile-512  { background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 50%, #5b21b6 100%); color: white; font-size: 1.3rem; box-shadow: 0 6px 24px rgba(109, 40, 217, 0.5), inset 0 1px 0 rgba(255,255,255,0.08); }
        .tile-1024 { background: linear-gradient(135deg, #6d28d9 0%, #5b21b6 50%, #4c1d95 100%); color: white; font-size: 1.2rem; box-shadow: 0 6px 24px rgba(91, 33, 182, 0.5), inset 0 1px 0 rgba(255,255,255,0.08); }
        .tile-2048 { background: linear-gradient(135deg, #34d399 0%, #10b981 50%, #059669 100%); color: white; font-size: 1.1rem; box-shadow: 0 0 30px rgba(16, 185, 129, 0.6), inset 0 1px 0 rgba(255,255,255,0.15); animation: glow 2s ease-in-out infinite; }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 24px rgba(16, 185, 129, 0.5); } 50% { box-shadow: 0 0 40px rgba(16, 185, 129, 0.9); } }
        @keyframes tilePop { 0% { transform: scale(1); } 40% { transform: scale(1.25); } 100% { transform: scale(1); } }
        @keyframes tileAppear { 0% { transform: scale(0); opacity: 0; } 60% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
        .arrow-controls {
            display: flex; flex-direction: column; align-items: center; gap: 8px; margin-top: 16px;
            background: rgba(31, 41, 55, 0.6); padding: 16px; border-radius: 0.75rem;
            border: 2px solid rgba(107, 114, 128, 0.3);
        }
        .arrow-row { display: flex; gap: 8px; }
        .arrow-btn {
            width: 48px; height: 48px; border: none; border-radius: 0.5rem;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white; cursor: pointer; font-size: 1.5rem;
            transition: all 0.2s ease; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            display: flex; align-items: center; justify-content: center;
        }
        .arrow-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(59, 130, 246, 0.5); }
        .arrow-btn:active { transform: scale(0.92); box-shadow: 0 2px 6px rgba(59, 130, 246, 0.4); }
    </style>
    <script src="theme_manager.js"></script>
</head>
<body class="dark-mode bg-gray-900 min-h-screen text-white">
<script src="scripts/taskbar.js"></script>

<!-- Translation Scripts -->
<script src="scripts/global_translations.js?v=8.0"></script>
<script src="scripts/spanish_translations.js?v=1.0"></script>
<script src="scripts/hindi_translations.js?v=1.0"></script>

<div class="flex flex-row items-start justify-start p-4 gap-10 overflow-x-auto overflow-y-visible">
    <div id="game-wrapper" class="relative flex-shrink-0 max-w-md bg-gray-800 rounded-2xl shadow-2xl p-6 border border-gray-700">
        <div class="flex justify-between items-end mb-4">
            <div>
                <h1 class="text-2xl font-bold bg-gradient-to-r from-amber-400 to-orange-500 bg-clip-text text-transparent" data-i18n="2048">2048</h1>
                <p class="text-xs text-gray-400 font-sans" data-i18n="Slide tiles, merge to 2048!">Slide tiles, merge to 2048!</p>
            </div>
            <div class="flex gap-4 text-right">
                <div>
                    <div class="text-xs text-gray-400 font-sans" data-i18n="SCORE">SCORE</div>
                    <div id="score" class="text-3xl font-bold text-white">0</div>
                </div>
                <div>
                    <div class="text-xs text-gray-400 font-sans">BEST</div>
                    <div id="best-score" class="text-3xl font-bold text-amber-300">0</div>
                </div>
            </div>
        </div>

        <div class="flex gap-2 mb-3">
            <button onclick="undoMove()" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-3 rounded-lg text-xs transition active:scale-95" title="Undo">↩ UNDO</button>
            <button onclick="resetGame()" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-3 rounded-lg text-xs transition active:scale-95" title="New Game">🔄 NEW</button>
        </div>

        <div id="board" class="grid-2048"></div>

        <p class="text-center text-xs text-gray-500 mt-4 font-sans" data-i18n="Arrow keys / WASD / Swipe to slide">Arrow keys / WASD / Swipe to slide</p>

        <div class="arrow-controls">
            <div class="arrow-row" style="justify-content:center;margin-bottom:4px;">
                <button class="arrow-btn" onclick="move('up')" title="Up">⬆️</button>
            </div>
            <div class="arrow-row">
                <button class="arrow-btn" onclick="move('left')" title="Left">⬅️</button>
                <button class="arrow-btn" onclick="move('down')" title="Down">⬇️</button>
                <button class="arrow-btn" onclick="move('right')" title="Right">➡️</button>
            </div>
        </div>

        <!-- Game Over Overlay -->
        <div id="game-over" class="hidden absolute inset-0 bg-black/90 rounded-2xl z-20 flex flex-col items-center justify-center text-center p-6 backdrop-blur-sm">
            <h2 id="end-title" class="text-3xl font-bold mb-2 text-red-500">GAME OVER</h2>
            <p id="end-msg" class="text-gray-300 mb-6 font-sans">No moves left!</p>
            <div class="text-4xl font-bold text-white mb-8" id="final-score">0</div>
            <button onclick="resetGame()" class="bg-amber-600 hover:bg-amber-500 text-white font-bold py-3 px-8 rounded-lg shadow-lg transform transition active:scale-95" data-i18n="TRY AGAIN">
                TRY AGAIN
            </button>
        </div>

        <!-- Win Overlay -->
        <div id="win-screen" class="hidden absolute inset-0 bg-black/80 rounded-2xl z-20 flex flex-col items-center justify-center text-center p-6 backdrop-blur-sm">
            <h2 class="text-3xl font-bold mb-4 text-green-400">🎉 2048!</h2>
            <p class="text-gray-300 mb-6 font-sans">You reached 2048!</p>
            <div class="flex gap-4">
                <button onclick="continueGame()" class="bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-8 rounded-lg shadow-lg">CONTINUE</button>
                <button onclick="resetGame()" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-8 rounded-lg shadow-lg">NEW GAME</button>
            </div>
        </div>
    </div>

    <div id="game-sidebar">
        <div style="width:100%;text-align:center;color:#9ca3af;margin-bottom:1rem;font-size:0.875rem;font-weight:600;">
            ⭐ TOKEN SESSION
        </div>
    </div>
</div>

<script>
    let grid = [], score = 0, gameActive = true, won2048 = false;
    let bestScore = parseInt(localStorage.getItem('2048_best') || '0');
    let prevGrid = null, prevScore = 0;
    let moveCount = 0;

    document.getElementById('best-score').textContent = bestScore;

    function init() {
        grid = Array.from({length: 4}, () => Array(4).fill(0));
        score = 0; gameActive = true; won2048 = false;
        prevGrid = null; prevScore = 0; moveCount = 0;
        document.getElementById('score').textContent = '0';
        document.getElementById('game-over').classList.add('hidden');
        document.getElementById('win-screen').classList.add('hidden');
        addRandom(); addRandom();
        render();
    }

    function addRandom() {
        const empty = [];
        for (let r = 0; r < 4; r++) for (let c = 0; c < 4; c++) if (grid[r][c] === 0) empty.push({r, c});
        if (empty.length === 0) return;
        const {r, c} = empty[Math.floor(Math.random() * empty.length)];
        grid[r][c] = Math.random() < 0.9 ? 2 : 4;
    }

    function render(mergedCells) {
        const board = document.getElementById('board');
        board.innerHTML = '';
        for (let r = 0; r < 4; r++) {
            for (let c = 0; c < 4; c++) {
                const tile = document.createElement('div');
                const val = grid[r][c];
                const cls = val <= 2048 ? 'tile-' + val : 'tile-2048';
                tile.className = 'tile ' + cls;
                tile.textContent = val || '';
                if (mergedCells && mergedCells.has(r + ',' + c)) {
                    tile.style.animation = 'tilePop 0.25s ease';
                }
                if (val && !mergedCells) {
                    tile.style.animation = 'tileAppear 0.15s ease';
                }
                board.appendChild(tile);
            }
        }
        // Score pulse animation
        const scoreEl = document.getElementById('score');
        scoreEl.style.transition = 'transform 0.15s ease';
        scoreEl.style.transform = 'scale(1.15)';
        setTimeout(() => scoreEl.style.transform = 'scale(1)', 150);
    }

    function slide(row) {
        let arr = row.filter(v => v !== 0);
        let mergedIndices = [];
        for (let i = 0; i < arr.length - 1; i++) {
            if (arr[i] === arr[i + 1]) {
                arr[i] *= 2;
                score += arr[i];
                if (arr[i] === 2048 && !won2048) { won2048 = true; }
                arr.splice(i + 1, 1);
                mergedIndices.push(i);
            }
        }
        while (arr.length < 4) arr.push(0);
        return {result: arr, merged: mergedIndices};
    }

    function undoMove() {
        if (!prevGrid) return;
        grid = prevGrid.map(row => [...row]);
        score = prevScore;
        gameActive = true;
        document.getElementById('score').textContent = score;
        document.getElementById('game-over').classList.add('hidden');
        render();
        prevGrid = null; // can only undo once
    }

    function move(direction) {
        if (!gameActive) return;
        const oldGrid = JSON.stringify(grid);

        // Save state for undo
        prevGrid = grid.map(row => [...row]);
        prevScore = score;

        let mergedCells = new Set();

        if (direction === 'left') {
            for (let r = 0; r < 4; r++) {
                const {result, merged} = slide(grid[r]);
                grid[r] = result;
                merged.forEach(i => mergedCells.add(r + ',' + i));
            }
        } else if (direction === 'right') {
            for (let r = 0; r < 4; r++) {
                const {result, merged} = slide(grid[r].reverse());
                grid[r] = result.reverse();
                merged.forEach(i => mergedCells.add(r + ',' + (3-i)));
            }
        } else if (direction === 'up') {
            for (let c = 0; c < 4; c++) {
                let col = [grid[0][c], grid[1][c], grid[2][c], grid[3][c]];
                const {result, merged} = slide(col);
                for (let r = 0; r < 4; r++) grid[r][c] = result[r];
                merged.forEach(i => mergedCells.add(i + ',' + c));
            }
        } else if (direction === 'down') {
            for (let c = 0; c < 4; c++) {
                let col = [grid[3][c], grid[2][c], grid[1][c], grid[0][c]];
                const {result, merged} = slide(col);
                for (let r = 0; r < 4; r++) grid[3 - r][c] = result[r];
                merged.forEach(i => mergedCells.add((3-i) + ',' + c));
            }
        }

        if (JSON.stringify(grid) !== oldGrid) {
            moveCount++;
            addRandom();
            document.getElementById('score').textContent = score;

            // Update best score
            if (score > bestScore) {
                bestScore = score;
                localStorage.setItem('2048_best', bestScore);
                document.getElementById('best-score').textContent = bestScore;
            }

            render(mergedCells);

            if (won2048) {
                won2048 = false;
                document.getElementById('win-screen').classList.remove('hidden');
                return;
            }

            if (!canMove()) {
                gameActive = false;
                document.getElementById('final-score').textContent = score;
                document.getElementById('game-over').classList.remove('hidden');
            }
        } else {
            prevGrid = null; // no actual move, don't save undo state
        }
    }

    function canMove() {
        for (let r = 0; r < 4; r++) for (let c = 0; c < 4; c++) {
            if (grid[r][c] === 0) return true;
            if (c < 3 && grid[r][c] === grid[r][c + 1]) return true;
            if (r < 3 && grid[r][c] === grid[r + 1][c]) return true;
        }
        return false;
    }

    function resetGame() { init(); }
    function continueGame() {
        document.getElementById('win-screen').classList.add('hidden');
    }

    // Keyboard
    document.addEventListener('keydown', e => {
        switch (e.key) {
            case 'ArrowUp': case 'w': case 'W': move('up'); e.preventDefault(); break;
            case 'ArrowDown': case 's': case 'S': move('down'); e.preventDefault(); break;
            case 'ArrowLeft': case 'a': case 'A': move('left'); e.preventDefault(); break;
            case 'ArrowRight': case 'd': case 'D': move('right'); e.preventDefault(); break;
        }
    });

    // Touch / Swipe
    let touchStart = null;
    document.addEventListener('touchstart', e => {
        touchStart = {x: e.touches[0].clientX, y: e.touches[0].clientY};
    });
    document.addEventListener('touchend', e => {
        if (!touchStart) return;
        const dx = e.changedTouches[0].clientX - touchStart.x;
        const dy = e.changedTouches[0].clientY - touchStart.y;
        if (Math.abs(dx) > Math.abs(dy)) {
            if (dx > 30) move('right'); else if (dx < -30) move('left');
        } else {
            if (dy > 30) move('down'); else if (dy < -30) move('up');
        }
        touchStart = null;
    });

    init();

</script>
</body>
</html>

