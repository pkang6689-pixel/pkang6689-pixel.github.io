<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ArisEdu Forums</title>
  <!-- <script src="/_sdk/element_sdk.js"></script> -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: ['class', '.dark-mode']
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&amp;display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/ArisEdu Project Folder/styles/main.css">
  <script src="theme_manager.js"></script>
  <!-- Firebase -->
  <script type="module">
     import { db, setDoc, doc, getDoc, deleteDoc, updateDoc, auth, collection, addDoc, getDocs, orderBy, query, limit, serverTimestamp, onAuthStateChanged } from "./firebase-config.js";
     window.db = db;
     window.setDoc = setDoc;
     window.doc = doc;
     window.getDoc = getDoc;
     window.deleteDoc = deleteDoc;
     window.updateDoc = updateDoc;
     window.auth = auth;
     
     // New exports for forums
     window.collection = collection;
     window.addDoc = addDoc;
     window.getDocs = getDocs;
     window.orderBy = orderBy;
     window.query = query;
     window.limit = limit;
     window.serverTimestamp = serverTimestamp;

    // Load initial posts
    // loadForumPosts(); <-- REMOVE AUTO LOAD HERE, wait for body

    let currentUser = null;

    onAuthStateChanged(auth, (user) => {
        currentUser = user;
        loadForumPosts();
    });

    async function loadForumPosts() {
        // Double check if DOM is ready, if not, retry in 100ms
        const list = document.getElementById('suggestions-list');
        if (!list) {
            setTimeout(loadForumPosts, 200);
            return;
        }

        try {
            // Updated query to fix "orderBy" vs "where" issue if indexes aren't built yet
            // If you get an index error in console, click the link in the error to build it!
            // For now, let's keep it simple to avoid index requirements if possible.
            // actually orderBy usually requires an index if mixed with where, but here we just have a collection group query.
            
            const threadsRef = collection(db, "forum_posts");
            const q = query(threadsRef, orderBy("createdAt", "desc"), limit(20));
            
            const querySnapshot = await getDocs(q);
            
            if (querySnapshot.empty) {
                list.innerHTML = '<p class="text-slate-500 dark:text-gray-400">No suggestions yet. Be the first!</p>';
                return;
            }

            list.innerHTML = '';
            querySnapshot.forEach((docSnap) => {
                const data = docSnap.data();
                
                // Skip deleted posts
                if (data.deleted) return;

                const docId = docSnap.id;
                let date = 'Just now';
                if(data.createdAt && data.createdAt.toDate) {
                     date = data.createdAt.toDate().toLocaleDateString() + ' ' + data.createdAt.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                }

                // Color mapping
                const isDark = document.body.classList.contains('dark-mode');
                const colors = {
                    feature: isDark ? 'text-blue-300' : 'text-blue-700',
                    content: isDark ? 'text-green-300' : 'text-green-700',
                    bug: isDark ? 'text-red-300' : 'text-red-700',
                    other: isDark ? 'text-gray-300' : 'text-gray-600'
                };
                const badgeColor = colors[data.category] || (isDark ? 'text-gray-300' : 'text-gray-600');
                
                // Create badge background for better visibility
                const bgColors = {
                     feature: isDark ? 'bg-blue-900/50 border-blue-700' : 'bg-blue-100 border-blue-300',
                     content: isDark ? 'bg-green-900/50 border-green-700' : 'bg-green-100 border-green-300',
                     bug: isDark ? 'bg-red-900/50 border-red-700' : 'bg-red-100 border-red-300',
                     other: isDark ? 'bg-gray-700/50 border-gray-600' : 'bg-gray-100 border-gray-300'
                };
                const badgeStyle = bgColors[data.category] || (isDark ? 'bg-gray-700/50 border-gray-600' : 'bg-gray-100 border-gray-300');

                const item = document.createElement('div');
                item.className = isDark 
                    ? 'p-6 bg-slate-800/80 rounded-xl border border-slate-700 shadow-lg mb-4 hover:border-slate-500 transition-colors relative'
                    : 'p-6 bg-white rounded-xl border border-slate-200 shadow-md mb-4 hover:border-slate-400 transition-colors relative';
                
                // Safe Author Name
                const author = data.authorName || 'Anonymous';
                
                // Delete button logic
                let deleteButton = '';
                
                // Allow delete if:
                // 1. User owns the post via UID (Secure)
                // 2. Post has no UID but Author Name matches (Legacy/Insecure but useful for cleanup)
                // 3. Current user is a specific admin email (Optional override)
                
                const isOwner = (currentUser && data.uid === currentUser.uid);
                const isLegacyOwner = (!data.uid && currentUser && (data.authorName === currentUser.displayName || data.authorName === currentUser.email));
                
                if (isOwner || isLegacyOwner) {
                    deleteButton = `
                        <button onclick="window.deletePost('${docId}')" class="absolute top-4 right-4 text-gray-500 hover:text-red-500 transition-colors" title="Delete Suggestion">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    `;
                }

                item.innerHTML = `
                    ${deleteButton}
                    <div class="flex justify-between items-start mb-3 pr-8">
                        <div class="flex items-center gap-3">
                            <span class="${badgeColor} px-2 py-1 rounded text-xs font-bold uppercase tracking-wider border ${badgeStyle}">${data.category}</span>
                            <span class="text-sm ${isDark ? 'text-gray-400' : 'text-slate-500'} font-medium">${author}</span>
                        </div>
                        <span class="${isDark ? 'text-slate-500' : 'text-slate-400'} text-xs">${date}</span>
                    </div>
                    <p class="${isDark ? 'text-gray-100' : 'text-slate-800'} text-lg leading-relaxed">${data.message}</p>
                `;
                list.appendChild(item);
            });
        } catch (e) {
            console.error("Error loading posts: ", e);
            list.innerHTML = `<p class="text-red-400">Error loading posts. (${e.message})</p>`;
        }
    }
    window.loadForumPosts = loadForumPosts;
    
    // Delete function (Soft Delete)
    window.deletePost = async function(docId) {
        if(!confirm('Are you sure you want to delete this suggestion?')) return;
        
        try {
            await updateDoc(doc(db, "forum_posts", docId), {
                deleted: true
            });
            // Reload list
            loadForumPosts();
        } catch (e) {
            alert("Error deleting post: " + e.message);
            console.error(e);
        }
    }
    
    // Start loading when modules are ready
    if(document.readyState === 'loading') {
        // Wait for auth to trigger load
    } else {
        // loadForumPosts(); // Auth listener handles it
    }
  </script>
</head>
<body class="dark-mode h-full">
<script src="scripts/taskbar.js"></script>

<main class="main-container" style="max-width: 1000px; margin: 0 auto;">
    <h1 class="page-title" style="font-size: 3rem; margin-bottom: 2rem;">Student Forums</h1>
    
    <div class="courses-container" style="height: auto; min-height: 60vh;">
        <div class="flex flex-col gap-6">
            <!-- Suggestion Form -->
            <div class="bg-slate-100 dark:bg-white/10 p-6 rounded-2xl backdrop-blur-sm border border-slate-200 dark:border-transparent">
                <h2 class="text-2xl font-bold mb-4 text-slate-800 dark:text-white">Suggest a Feature</h2>
                <div id="forum-user-display" class="mb-4 text-blue-600 dark:text-blue-300 font-semibold" style="display:none;"></div>
                <form id="suggestion-form" onsubmit="handleSuggestion(event)">
                    <div class="mb-4">
                        <label class="block text-slate-700 dark:text-gray-200 mb-2">Category</label>
                        <select id="forum-category" class="w-full p-2 rounded bg-white dark:bg-slate-800 text-slate-800 dark:text-white border border-slate-300 dark:border-slate-600">
                            <option value="feature">New Feature</option>
                            <option value="content">Lesson Content</option>
                            <option value="bug">Bug Report</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-slate-700 dark:text-gray-200 mb-2">Your Suggestion</label>
                        <textarea id="forum-message" rows="4" class="w-full p-3 rounded bg-white dark:bg-slate-800 text-slate-800 dark:text-white border border-slate-300 dark:border-slate-600" placeholder="What should we add next?" required></textarea>
                    </div>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded-lg transition">
                        Submit Suggestion
                    </button>
                    <p id="forum-status" class="mt-2 text-green-500 dark:text-green-400 hidden">Thanks! Your suggestion has been recorded.</p>
                </form>
            </div>
            
            <!-- Removed Mockup List -->
            <div id="suggestions-list" class="space-y-4"></div>
        </div>
    </div>
</main>

<script>
    // Forum Logic
    (function() {
        const userStr = localStorage.getItem('user');
        const userDisplay = document.getElementById('forum-user-display');
        if (userStr && userDisplay) {
            try {
                const user = JSON.parse(userStr);
                const name = user.name || user.email || "Student";
                userDisplay.textContent = `Posting as: ${name}`;
                userDisplay.style.display = 'block';
            } catch(e) {}
        }
    })();

    async function handleSuggestion(e) {
        e.preventDefault();
        const category = document.getElementById('forum-category').value;
        const message = document.getElementById('forum-message').value;
        const status = document.getElementById('forum-status');

        if (window.db && window.addDoc && window.collection) {
            
            // Get User Info
            let authorName = "Anonymous";
            let uid = null;
            
            // Try Firebase Auth first for most accurate ID
            if (window.auth && window.auth.currentUser) {
                uid = window.auth.currentUser.uid;
                authorName = window.auth.currentUser.displayName || window.auth.currentUser.email || "Anonymous";
            }
            
            // Fallback/Legacy
            if (!uid) {
                const userStr = localStorage.getItem('user');
                if (userStr) {
                    try {
                        const user = JSON.parse(userStr);
                        authorName = authorName === "Anonymous" ? (user.name || user.email || "Anonymous") : authorName;
                        if(user.uid) uid = user.uid;
                    } catch(e) {}
                }
            }

            // Optimistic Update: Show success immediately!
            status.textContent = "Thank you! Suggestion processing...";
            status.classList.remove('hidden');
            status.className = "mt-2 text-green-400";
            
            const savedMessage = message; // Copy for use below
            document.getElementById('forum-message').value = '';
            
            // Background save (no await blocking the UI feedback)
            const suggestionData = {
                category: category,
                message: savedMessage,
                authorName: authorName,
                uid: uid,
                createdAt: window.serverTimestamp ? window.serverTimestamp() : new Date()
            };

            // Manually add to local list immediately for instant feedback
            const list = document.getElementById('suggestions-list');
            if (list) {
                // If it was empty state, clear it
                if (list.innerHTML.includes('No suggestions yet')) list.innerHTML = '';

                // Remove the "Just now" pulse logic if it causes jitter, 
                // Instead, just reload the list cleanly after save.
                // But for instant feedback, we inject a *clean* item.
                
                const tempDate = "Posting...";
                const colors = { feature: 'text-blue-300', content: 'text-green-300', bug: 'text-red-300', other: 'text-gray-300' };
                const badgeColor = colors[category] || 'text-gray-300';
                
                const item = document.createElement('div');
                item.className = 'p-6 bg-slate-800/80 rounded-xl border border-blue-500 shadow-lg mb-4 animate-pulse'; 
                item.id = 'temp-post'; 
                item.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-3">
                            <span class="${badgeColor} px-2 py-1 rounded text-xs font-bold uppercase tracking-wider border border-slate-600">${category}</span>
                            <span class="text-sm text-gray-400 font-medium">${authorName} (You)</span>
                        </div>
                        <span class="text-blue-400 text-xs font-bold">${tempDate}</span>
                    </div>
                    <p class="text-gray-100 text-lg leading-relaxed">${savedMessage}</p>
                `;
                list.insertBefore(item, list.firstChild);
            }

            // Actual Save
            try {
                // Ensure data is correct before sending
                const docRef = await window.addDoc(window.collection(window.db, "forum_posts"), suggestionData);
                console.log("Suggestion synced to Firebase successfully with ID: ", docRef.id);
                
                status.textContent = "Saved successfully!";
                status.className = "mt-2 text-green-400";
                
                // Reload list to get server timestamp and remove temp item
                setTimeout(() => {
                     // If standard load function exists
                     if(window.loadForumPosts) window.loadForumPosts();
                }, 1000);

            } catch (err) {
                console.error("Firestore Save Error:", err);
                status.textContent = "Wait... there was an error saving: " + err.message;
                status.className = "mt-2 text-red-400";
                // Optionally restore message
                document.getElementById('forum-message').value = savedMessage;
                // Remove temp item
                const temp = document.getElementById('temp-post');
                if(temp) temp.remove();
            }
            
            setTimeout(() => status.classList.add('hidden'), 5000);

        } else {
             // Fallback for offline dev
             alert("Database connection not ready. Check console.");
        }
    }
</script>
</body>
</html>
