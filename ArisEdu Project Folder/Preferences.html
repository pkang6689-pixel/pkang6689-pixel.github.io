<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Preferences</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&display=swap" rel="stylesheet">
  <script src="theme_manager.js?v=2.1"></script>
  <style>
    body {
      background: linear-gradient(135deg, #3b82f6 0%, #10b981 50%, #8b5cf6 100%);
      transition: background 0.3s;
    }
    body.dark-mode {
      background: #0f172a;
    }
    .settings-container {
      background: transparent;
      transition: background 0.3s;
    }
    body.dark-mode .settings-container {
      background: #1e293b;
    }
    body.aurora-mode .settings-container {
      background: linear-gradient(to right, #23243a, #334155, #1A2A6C);
    }
    body.aurora-mode.dark-mode .settings-container {
      background: linear-gradient(to right, #23243a, #334155, #1A2A6C);
    }
    /* .settings-menu styles are in main.css (position:fixed, z-index:10000) */
    
    /* Native Select and Input Styles for Preferences */
    .preferences-select,
    .preferences-input {
        margin-left: 0.75rem;
        padding: 0.3rem 0.6rem;
        border-radius: 0.4rem;
        background-color: #fff;
        color: #333;
        border: 1px solid #e2e8f0;
    }
    body.dark-mode .preferences-select,
    body.dark-mode .preferences-input {
        background-color: #273244;
        color: #e2e8f0;
        border-color: #334155;
    }

    /* Custom Select Styles */
    .custom-select-wrapper {
        position: relative;
        user-select: none;
        width: 100%;
        max-width: 300px;
        margin-left: 0.75rem;
    }
    .custom-select {
        position: relative;
        display: flex;
        flex-direction: column;
    }
    .custom-select-trigger {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem 1rem;
        font-size: 1rem;
        font-weight: 500;
        color: #333;
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    body.dark-mode .custom-select-trigger {
        background: #273244;
        color: #e2e8f0;
        border-color: #334155;
    }
    .custom-options {
        position: absolute;
        display: block;
        top: 100%;
        left: 0;
        right: 0;
        background: #fff;
        border: 1px solid #e2e8f0;
        border-top: 0;
        border-bottom-left-radius: 0.5rem;
        border-bottom-right-radius: 0.5rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        z-index: 50;
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        transform: translateY(-10px);
        transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
        margin-top: 0.5rem;
        max-height: 200px;
        overflow-y: auto;
    }
    body.dark-mode .custom-options {
        background: #1e293b;
        border-color: #334155;
    }
    .custom-select.open .custom-options {
        opacity: 1;
        visibility: visible;
        pointer-events: all;
        transform: translateY(0);
    }
    .custom-option {
        position: relative;
        display: block;
        padding: 0.75rem 1rem;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border-bottom: 1px solid #f1f5f9;
        
        /* Gradient Text Base Styles */
        background-clip: text !important;
        -webkit-background-clip: text !important;
        -webkit-text-fill-color: transparent !important;
        color: transparent; 
    }
    body.dark-mode .custom-option {
        border-color: #334155;
    }
    .custom-option:last-of-type {
        border-bottom: 0;
    }
    .custom-option:hover {
        background-color: #f8fafc;
        transform: padding-left 5px;
    }
    body.dark-mode .custom-option:hover {
        background-color: #334155;
    }
    .custom-option.selected {
        background-color: #f1f5f9;
    }
    body.dark-mode .custom-option.selected {
        background-color: #475569;
    }

    /* Fixed Preferences Layout Styles */
    .preferences-layout {
      width: 90vw;
      height: 85vh;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border-radius: 2rem;
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
      font-family: 'Poppins', sans-serif;
      display: flex;
      flex-direction: row;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      transition: background 0.3s, color 0.3s;
    }
    
    body.dark-mode .preferences-layout {
      background: rgba(30, 41, 59, 0.95);
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      color: #e2e8f0;
    }

    .preferences-sidebar {
      width: 18vw;
      min-width: 220px;
      background: #e0e7ef;
      border-radius: 2rem 0 0 2rem;
      padding: 2rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      transition: background 0.3s;
    }

    body.dark-mode .preferences-sidebar {
      background: #0f172a;
    }

    .sidebar-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 2rem;
      text-align: left;
      background: linear-gradient(135deg, #3b82f6 0%, #10b981 50%, #8b5cf6 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      color: transparent;
    }

    .sidebar-categories {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .settings-category {
      background: #fff;
      border: none;
      border-radius: 0.7rem;
      padding: 1rem;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      text-align: left;
      color: #334155;
      transition: all 0.2s;
    }

    /* Selected Gradient Text Style */
    .gradient-text-selected {
        background-clip: text !important;
        -webkit-background-clip: text !important;
        color: transparent !important;
        -webkit-text-fill-color: transparent !important;
        font-weight: 700 !important;
        display: inline-block !important;
    }

    body.dark-mode .settings-category {
      background: #1e293b;
      color: #e2e8f0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    }

    .settings-category:hover {
      transform: translateX(4px);
    }
    
    .preferences-panel {
      flex: 1;
      padding: 3rem;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: flex-start;
      color: #1e293b;
    }

    body.dark-mode .preferences-panel {
      color: #e2e8f0;
    }

  </style>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="styles/main.css">
</head>
<body class="dark-mode">
<script src="scripts/taskbar.js"></script>

<div class="preferences-layout">
  <aside class="preferences-sidebar">
    <h2 class="sidebar-title">Settings</h2>
    <div id="sidebar-categories" class="sidebar-categories">
      <button class="settings-category" data-category="appearance">Appearance</button>
      <button class="settings-category" data-category="account">Account</button>
    </div>
  </aside>
  <section id="settings-panel" class="preferences-panel">
    <!-- Settings options will be rendered here -->
  </section>
</div>
<script>
    // ...existing code...
// Sidebar and taskbar translations
const sidebarLabels = {
  english: {
    settings: 'Settings',
    appearance: 'Appearance',
    account: 'Account',
    search: '🔍 Search',
    homepage: '🏠 Homepage',
    courses: '📚 Courses',
    play: '▶️ Play',
    settingsBtn: '⚙️ Settings',
    loginSignup: '🔐 Login/Signup',
    preferences: 'Preferences',
    darkMode: 'Dark Mode',
  },
  spanish: {
    settings: 'Configuración',
    appearance: 'Apariencia',
    account: 'Cuenta',
    search: '🔍 Buscar',
    homepage: '🏠 Inicio',
    courses: '📚 Cursos',
    play: '▶️ Jugar',
    settingsBtn: '⚙️ Configuración',
    loginSignup: '🔐 Iniciar sesión / Registrarse',
    preferences: 'Preferencias',
    darkMode: 'Modo oscuro',
  },
  chinese: {
    settings: '设置',
    appearance: '外观',
    account: '账户',
    search: '🔍 搜索',
    homepage: '🏠 首页',
    courses: '📚 课程',
    play: '▶️ 玩',
    settingsBtn: '⚙️ 设置',
    loginSignup: '🔐 登录/注册',
    preferences: '偏好设置',
    darkMode: '深色模式',
  }
};

function updateSidebarLanguage() {
  const lang = localStorage.getItem('arisEduLanguage') || 'english';
  const labels = sidebarLabels[lang] || sidebarLabels['english'];
  const el = (sel) => document.querySelector(sel);
  const byId = (id) => document.getElementById(id);
  const safeText = (node, text) => { if (node) node.textContent = text; };

  safeText(el('aside h2'), labels.settings);
  const buttons = document.querySelectorAll('.settings-category');
  if (buttons.length >= 2) {
    buttons[0].textContent = labels.appearance;
    buttons[1].textContent = labels.account;
  }
  safeText(byId('search-button'), labels.search);
  safeText(byId('homepage-button'), labels.homepage);
  safeText(byId('course-button'), labels.courses);
  safeText(byId('settings-button'), labels.settingsBtn);

  // Preserve login-signup button username if logged in
  const loginBtn = byId('login-signup-button');
  if (loginBtn) {
    const username = localStorage.getItem('arisEduAccountEmail') || '';
    const userJson = localStorage.getItem('user');
    let displayName = '';
    if (userJson) { try { const u = JSON.parse(userJson); displayName = u.name || u.email || ''; } catch(e){} }
    if (!displayName) displayName = username;
    loginBtn.textContent = displayName ? `👤 ${displayName}` : labels.loginSignup;
  }

  // Settings menu
  const darkModeSpan = el('#settings-menu .settings-item span');
  const prefsLink = el('#settings-menu .settings-item + a');
  safeText(darkModeSpan, labels.darkMode);
  safeText(prefsLink, labels.preferences);
}
const settingsOptions = {
  appearance_en: `
    <h2 style="font-size: 2rem; font-weight: 700; margin-bottom: 2rem;">Appearance Settings</h2>
    <form id="appearance-form">
      <div style="margin-bottom: 1.5rem;">
        <label style="display: flex; align-items: center; gap: 0.75rem; font-size: 1.1rem;">
          <input type="checkbox" id="darkModeToggle" />
          <span>Enable Dark Mode</span>
        </label>
      </div>
      <div style="margin-bottom: 1.5rem;">
          <label style="font-size: 1.1rem;">Language:
            <select id="languageSelect" class="preferences-select">
              <option value="english">English</option>
              <option value="spanish">Español</option>
              <option value="chinese">中文</option>
              <option value="traditional">繁體中文</option>
            </select>
          </label>
      </div>
      <div style="margin-bottom: 1.5rem;">
        <label style="font-size: 1.1rem;">Suggested Color Themes:</label>
        <div class="custom-select-wrapper">
            <div class="custom-select" id="customThemeSelectSuggested">
                <div class="custom-select-trigger">
                    <span>Select Theme</span>
                    <div class="arrow">▼</div>
                </div>
                <div class="custom-options">
                    <span class="custom-option" data-value="blue-green" style="background: linear-gradient(135deg, #3b82f6 0%, #10b981 50%, #8b5cf6 100%);">Aurora (Default)</span>
                    <span class="custom-option" data-value="sunset" style="background: linear-gradient(to right, #FF7E5F, #00C9A7, #1A2A6C);">Sunset</span>
                    <span class="custom-option" data-value="coral" style="background: linear-gradient(to right, #FF6F61, #40E0D0, #4B0082);">Coral reef</span>
                    <span class="custom-option" data-value="autumn" style="background: linear-gradient(to right, #CC5500, #DAA520, #8B4513);">Autumn</span>
                    <span class="custom-option" data-value="sunrise" style="background: linear-gradient(to right, #FFDAB9, #FF7F50, #FFFACD);">Sunrise</span>
                    <span class="custom-option" data-value="lavender" style="background: linear-gradient(to right, #C8A2C8, #9DC183, #FFFDD0);">Lavender</span>
                    <span class="custom-option" data-value="cyber" style="background: linear-gradient(to right, #000000, #00FFFF);">Cyber</span>
                </div>
            </div>
        </div>
      </div>
      <div style="margin-bottom: 1.5rem;">
        <label style="font-size: 1.1rem;">Background Theme:</label>
        <div class="custom-select-wrapper">
            <div class="custom-select" id="customBackgroundSelect">
                <div class="custom-select-trigger">
                    <span>Select Background</span>
                    <div class="arrow">▼</div>
                </div>
                <div class="custom-options">
                    <span class="custom-option" data-value="default" style="-webkit-text-fill-color: initial !important; color: inherit !important;">Default (None)</span>
                    <span class="custom-option" data-value="aurora" style="background: linear-gradient(135deg, #3b82f6 0%, #10b981 50%, #8b5cf6 100%);">Aurora</span>
                    <span class="custom-option" data-value="sunset" style="background: linear-gradient(to right, #FF7E5F, #00C9A7, #1A2A6C);">Sunset</span>
                    <span class="custom-option" data-value="coral" style="background: linear-gradient(to right, #FF6F61, #40E0D0, #4B0082);">Coral reef</span>
                    <span class="custom-option" data-value="autumn" style="background: linear-gradient(to right, #CC5500, #DAA520, #8B4513);">Autumn</span>
                    <span class="custom-option" data-value="sunrise" style="background: linear-gradient(to right, #FFDAB9, #FF7F50, #FFFACD);">Sunrise</span>
                    <span class="custom-option" data-value="lavender" style="background: linear-gradient(to right, #C8A2C8, #9DC183, #FFFDD0);">Lavender</span>
                    <span class="custom-option" data-value="cyber" style="background: linear-gradient(to right, #000000, #00FFFF);">Cyber</span>
                </div>
            </div>
            <input type="hidden" id="backgroundThemeInput"> 
        </div>
      </div>
      <div style="margin-bottom: 1.5rem;">
        <label style="font-size: 1.1rem;">Other Color Themes:</label>
        <div class="custom-select-wrapper">
            <div class="custom-select" id="customThemeSelectOther">
                <div class="custom-select-trigger">
                    <span>Select Theme</span>
                    <div class="arrow">▼</div>
                </div>
                <div class="custom-options">
                    <span class="custom-option" data-value="aurora-veil" style="background: linear-gradient(to right, #32CD32, #00FFFF, #8A2BE2);">Aurora veil</span>
                    <span class="custom-option" data-value="twilight" style="background: linear-gradient(to right, #50C878, #0F52BA, #FF00FF);">Twilight</span>
                    <span class="custom-option" data-value="forest" style="background: linear-gradient(to right, #228B22, #87CEEB, #E6E6FA);">Forest mist</span>
                    <span class="custom-option" data-value="ocean-mist" style="background: linear-gradient(to right, #001F3F, #3D9970, #E0FFFF);">Ocean Mist</span>
                    <span class="custom-option" data-value="solar" style="background: linear-gradient(to right, #FFD700, #DC143C, #2E0854);">Solar</span>
                    <span class="custom-option" data-value="crimson" style="background: linear-gradient(to right, #FFC0CB, #C21E56, #420D09);">Crimson</span>
                    <span class="custom-option" data-value="monochrome" style="background: linear-gradient(to right, #2C2C2C, #C0C0C0, #FFFFFF);">Monochrome</span>
                    <span class="custom-option" data-value="horizon" style="background: linear-gradient(to right, #708090, #4682B4, #FFFFF0);">Horizon</span>
                </div>
            </div>
            <input type="hidden" id="colorThemeSelect">  
        </div>
        <p style="font-size: 0.9rem; opacity: 0.7; margin-top: 0.5rem; font-style: italic;">* Reload to apply</p>
      </div>
    </form>
  `,
  appearance_zh: `
    <h2 style="font-size: 2rem; font-weight: 700; margin-bottom: 2rem;">外观设置</h2>
    <form id="appearance-form">
      <div style="margin-bottom: 1.5rem;">
        <label style="display: flex; align-items: center; gap: 0.75rem; font-size: 1.1rem;">
          <input type="checkbox" id="darkModeToggle" />
          <span>启用深色模式</span>
        </label>
      </div>
      <div style="margin-bottom: 1.5rem;">
          <label style="font-size: 1.1rem;">语言:
            <select id="languageSelect" class="preferences-select">
              <option value="english">English</option>
              <option value="spanish">Español</option>
              <option value="chinese">中文</option>
              <option value="traditional">繁體中文</option>
            </select>
          </label>
      </div>
      <div style="margin-bottom: 1.5rem;">
        <label style="font-size: 1.1rem;">推荐主题颜色:</label>
        <div class="custom-select-wrapper">
            <div class="custom-select" id="customThemeSelectSuggested">
                <div class="custom-select-trigger">
                    <span>Select Theme</span>
                    <div class="arrow">▼</div>
                </div>
                <div class="custom-options">
                    <span class="custom-option" data-value="blue-green" style="background: linear-gradient(135deg, #3b82f6 0%, #10b981 50%, #8b5cf6 100%);">极光 (默认)</span>
                    <span class="custom-option" data-value="sunset" style="background: linear-gradient(to right, #FF7E5F, #00C9A7, #1A2A6C);">日落</span>
                    <span class="custom-option" data-value="coral" style="background: linear-gradient(to right, #FF6F61, #40E0D0, #4B0082);">珊瑚礁</span>
                    <span class="custom-option" data-value="autumn" style="background: linear-gradient(to right, #CC5500, #DAA520, #8B4513);">秋天</span>
                    <span class="custom-option" data-value="sunrise" style="background: linear-gradient(to right, #FFDAB9, #FF7F50, #FFFACD);">日出</span>
                    <span class="custom-option" data-value="lavender" style="background: linear-gradient(to right, #C8A2C8, #9DC183, #FFFDD0);">薰衣草</span>
                    <span class="custom-option" data-value="cyber" style="background: linear-gradient(to right, #000000, #00FFFF);">赛博</span>
                </div>
            </div>
        </div>
      </div>
      <div style="margin-bottom: 1.5rem;">
        <label style="font-size: 1.1rem;">背景主题:</label>
        <div class="custom-select-wrapper">
            <div class="custom-select" id="customBackgroundSelect">
                <div class="custom-select-trigger">
                    <span>选择背景</span>
                    <div class="arrow">▼</div>
                </div>
                <div class="custom-options">
                    <span class="custom-option" data-value="default" style="-webkit-text-fill-color: initial !important; color: inherit !important;">默认 (无)</span>
                    <span class="custom-option" data-value="aurora" style="background: linear-gradient(135deg, #3b82f6 0%, #10b981 50%, #8b5cf6 100%);">极光</span>
                    <span class="custom-option" data-value="sunset" style="background: linear-gradient(to right, #FF7E5F, #00C9A7, #1A2A6C);">日落</span>
                    <span class="custom-option" data-value="coral" style="background: linear-gradient(to right, #FF6F61, #40E0D0, #4B0082);">珊瑚礁</span>
                    <span class="custom-option" data-value="autumn" style="background: linear-gradient(to right, #CC5500, #DAA520, #8B4513);">秋天</span>
                    <span class="custom-option" data-value="sunrise" style="background: linear-gradient(to right, #FFDAB9, #FF7F50, #FFFACD);">日出</span>
                    <span class="custom-option" data-value="lavender" style="background: linear-gradient(to right, #C8A2C8, #9DC183, #FFFDD0);">薰衣草</span>
                    <span class="custom-option" data-value="cyber" style="background: linear-gradient(to right, #000000, #00FFFF);">赛博</span>
                </div>
            </div>
            <input type="hidden" id="backgroundThemeInput"> 
        </div>
      </div>
      <div style="margin-bottom: 1.5rem;">
        <label style="font-size: 1.1rem;">其他主题颜色:</label>
        <div class="custom-select-wrapper">
            <div class="custom-select" id="customThemeSelectOther">
                <div class="custom-select-trigger">
                    <span>Select Theme</span>
                    <div class="arrow">▼</div>
                </div>
                <div class="custom-options">
                    <span class="custom-option" data-value="aurora-veil" style="background: linear-gradient(to right, #32CD32, #00FFFF, #8A2BE2);">极光面纱</span>
                    <span class="custom-option" data-value="twilight" style="background: linear-gradient(to right, #50C878, #0F52BA, #FF00FF);">暮光</span>
                    <span class="custom-option" data-value="forest" style="background: linear-gradient(to right, #228B22, #87CEEB, #E6E6FA);">迷雾森林</span>
                    <span class="custom-option" data-value="ocean-mist" style="background: linear-gradient(to right, #001F3F, #3D9970, #E0FFFF);">海洋迷雾</span>
                    <span class="custom-option" data-value="solar" style="background: linear-gradient(to right, #FFD700, #DC143C, #2E0854);">太阳能</span>
                    <span class="custom-option" data-value="crimson" style="background: linear-gradient(to right, #FFC0CB, #C21E56, #420D09);">绯红</span>
                    <span class="custom-option" data-value="monochrome" style="background: linear-gradient(to right, #2C2C2C, #C0C0C0, #FFFFFF);">单色</span>
                    <span class="custom-option" data-value="horizon" style="background: linear-gradient(to right, #708090, #4682B4, #FFFFF0);">地平线</span>
                </div>
            </div>
            <input type="hidden" id="colorThemeSelect"> 
        </div>
        <p style="font-size: 0.9rem; opacity: 0.7; margin-top: 0.5rem; font-style: italic;">* 刷新页面以应用</p>
      </div>
    </form>
  `,
  account_en: `
    <h2 style="font-size: 2rem; font-weight: 700; margin-bottom: 2rem;">Account Settings</h2>
    <form id="account-form">
      <div style="margin-bottom: 1.5rem;">
        <label style="font-size: 1.1rem;">Email:
          <input type="email" id="accountEmail" class="preferences-input" placeholder="user@example.com" />
        </label>
      </div>
      <div style="margin-bottom: 1.5rem;">
        <label style="font-size: 1.1rem;">Password:
          <input type="password" id="accountPassword" class="preferences-input" placeholder="••••••••" />
        </label>
        <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; margin-top: 0.5rem; cursor: pointer;">
            <input type="checkbox" id="showPasswordToggle"> <span>Show Password</span>
        </label>
      </div>
      <div style="margin-bottom: 1.5rem;">
        <button type="button" id="changePasswordBtn" style="padding: 0.6rem 1.5rem; border-radius: 0.5rem; font-weight: 600; font-size: 1rem; cursor: pointer; border: none; color: white; background: linear-gradient(135deg, #3b82f6, #10b981); transition: opacity 0.2s;" onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">🔒 Change Password</button>
        <div id="changePasswordSection" style="display:none; margin-top: 1rem;">
          <div style="margin-bottom: 0.75rem;">
            <label style="font-size: 1rem;">Current Password:
              <input type="password" id="currentPassword" class="preferences-input" placeholder="Enter current password" style="display:block; margin-top:0.25rem; width:100%; max-width:300px;" />
            </label>
          </div>
          <div style="margin-bottom: 0.75rem;">
            <label style="font-size: 1rem;">New Password:
              <input type="password" id="newPassword" class="preferences-input" placeholder="Enter new password" style="display:block; margin-top:0.25rem; width:100%; max-width:300px;" />
            </label>
          </div>
          <div style="margin-bottom: 0.75rem;">
            <label style="font-size: 1rem;">Confirm New Password:
              <input type="password" id="confirmNewPassword" class="preferences-input" placeholder="Confirm new password" style="display:block; margin-top:0.25rem; width:100%; max-width:300px;" />
            </label>
          </div>
          <button type="button" id="savePasswordBtn" style="padding: 0.5rem 1.25rem; border-radius: 0.5rem; font-weight: 600; font-size: 0.95rem; cursor: pointer; border: none; color: white; background: #16a34a; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">Save Password</button>
          <span id="passwordMsg" style="margin-left: 0.75rem; font-size: 0.9rem;"></span>
        </div>
      </div>
    </form>
  `,
  account_zh: `
    <h2 style="font-size: 2rem; font-weight: 700; margin-bottom: 2rem;">账户设置</h2>
    <form id="account-form">
      <div style="margin-bottom: 1.5rem;">
        <label style="font-size: 1.1rem;">邮箱:
          <input type="email" id="accountEmail" class="preferences-input" placeholder="user@example.com" />
        </label>
      </div>
      <div style="margin-bottom: 1.5rem;">
        <label style="font-size: 1.1rem;">密码:
          <input type="password" id="accountPassword" class="preferences-input" placeholder="••••••••" />
        </label>
        <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; margin-top: 0.5rem; cursor: pointer;">
            <input type="checkbox" id="showPasswordToggle"> <span>显示密码</span>
        </label>
      </div>
      <div style="margin-bottom: 1.5rem;">
        <button type="button" id="changePasswordBtn" style="padding: 0.6rem 1.5rem; border-radius: 0.5rem; font-weight: 600; font-size: 1rem; cursor: pointer; border: none; color: white; background: linear-gradient(135deg, #3b82f6, #10b981); transition: opacity 0.2s;" onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">🔒 更改密码</button>
        <div id="changePasswordSection" style="display:none; margin-top: 1rem;">
          <div style="margin-bottom: 0.75rem;">
            <label style="font-size: 1rem;">当前密码:
              <input type="password" id="currentPassword" class="preferences-input" placeholder="输入当前密码" style="display:block; margin-top:0.25rem; width:100%; max-width:300px;" />
            </label>
          </div>
          <div style="margin-bottom: 0.75rem;">
            <label style="font-size: 1rem;">新密码:
              <input type="password" id="newPassword" class="preferences-input" placeholder="输入新密码" style="display:block; margin-top:0.25rem; width:100%; max-width:300px;" />
            </label>
          </div>
          <div style="margin-bottom: 0.75rem;">
            <label style="font-size: 1rem;">确认新密码:
              <input type="password" id="confirmNewPassword" class="preferences-input" placeholder="确认新密码" style="display:block; margin-top:0.25rem; width:100%; max-width:300px;" />
            </label>
          </div>
          <button type="button" id="savePasswordBtn" style="padding: 0.5rem 1.25rem; border-radius: 0.5rem; font-weight: 600; font-size: 0.95rem; cursor: pointer; border: none; color: white; background: #16a34a; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">保存密码</button>
          <span id="passwordMsg" style="margin-left: 0.75rem; font-size: 0.9rem;"></span>
        </div>
      </div>
    </form>
  `,
  appearance_es: `
    <h2 style="font-size: 2rem; font-weight: 700; margin-bottom: 2rem;">Configuración de apariencia</h2>
    <form id="appearance-form">
      <div style="margin-bottom: 1.5rem;">
        <label style="display: flex; align-items: center; gap: 0.75rem; font-size: 1.1rem;">
          <input type="checkbox" id="darkModeToggle" />
          <span>Activar modo oscuro</span>
        </label>
      </div>
      <div style="margin-bottom: 1.5rem;">
          <label style="font-size: 1.1rem;">Idioma:
            <select id="languageSelect" class="preferences-select">
              <option value="english">English</option>
              <option value="spanish">Español</option>
              <option value="chinese">中文</option>
              <option value="traditional">繁體中文</option>
            </select>
          </label>
      </div>
      <div style="margin-bottom: 1.5rem;">
        <label style="font-size: 1.1rem;">Temas de color sugeridos:</label>
        <div class="custom-select-wrapper">
            <div class="custom-select" id="customThemeSelectSuggested">
                <div class="custom-select-trigger">
                    <span>Seleccionar tema</span>
                    <div class="arrow">▼</div>
                </div>
                <div class="custom-options">
                    <span class="custom-option" data-value="blue-green" style="background: linear-gradient(135deg, #3b82f6 0%, #10b981 50%, #8b5cf6 100%);">Aurora (Predeterminado)</span>
                    <span class="custom-option" data-value="sunset" style="background: linear-gradient(to right, #FF7E5F, #00C9A7, #1A2A6C);">Atardecer</span>
                    <span class="custom-option" data-value="coral" style="background: linear-gradient(to right, #FF6F61, #40E0D0, #4B0082);">Arrecife de coral</span>
                    <span class="custom-option" data-value="autumn" style="background: linear-gradient(to right, #CC5500, #DAA520, #8B4513);">Otoño</span>
                    <span class="custom-option" data-value="sunrise" style="background: linear-gradient(to right, #FFDAB9, #FF7F50, #FFFACD);">Amanecer</span>
                    <span class="custom-option" data-value="lavender" style="background: linear-gradient(to right, #C8A2C8, #9DC183, #FFFDD0);">Lavanda</span>
                    <span class="custom-option" data-value="cyber" style="background: linear-gradient(to right, #000000, #00FFFF);">Ciber</span>
                </div>
            </div>
        </div>
      </div>
      <div style="margin-bottom: 1.5rem;">
        <label style="font-size: 1.1rem;">Tema de fondo:</label>
        <div class="custom-select-wrapper">
            <div class="custom-select" id="customBackgroundSelect">
                <div class="custom-select-trigger">
                    <span>Seleccionar fondo</span>
                    <div class="arrow">▼</div>
                </div>
                <div class="custom-options">
                    <span class="custom-option" data-value="default" style="-webkit-text-fill-color: initial !important; color: inherit !important;">Predeterminado (Ninguno)</span>
                    <span class="custom-option" data-value="aurora" style="background: linear-gradient(135deg, #3b82f6 0%, #10b981 50%, #8b5cf6 100%);">Aurora</span>
                    <span class="custom-option" data-value="sunset" style="background: linear-gradient(to right, #FF7E5F, #00C9A7, #1A2A6C);">Atardecer</span>
                    <span class="custom-option" data-value="coral" style="background: linear-gradient(to right, #FF6F61, #40E0D0, #4B0082);">Arrecife de coral</span>
                    <span class="custom-option" data-value="autumn" style="background: linear-gradient(to right, #CC5500, #DAA520, #8B4513);">Otoño</span>
                    <span class="custom-option" data-value="sunrise" style="background: linear-gradient(to right, #FFDAB9, #FF7F50, #FFFACD);">Amanecer</span>
                    <span class="custom-option" data-value="lavender" style="background: linear-gradient(to right, #C8A2C8, #9DC183, #FFFDD0);">Lavanda</span>
                    <span class="custom-option" data-value="cyber" style="background: linear-gradient(to right, #000000, #00FFFF);">Ciber</span>
                </div>
            </div>
            <input type="hidden" id="backgroundThemeInput"> 
        </div>
      </div>
      <div style="margin-bottom: 1.5rem;">
        <label style="font-size: 1.1rem;">Otros temas de color:</label>
        <div class="custom-select-wrapper">
            <div class="custom-select" id="customThemeSelectOther">
                <div class="custom-select-trigger">
                    <span>Seleccionar tema</span>
                    <div class="arrow">▼</div>
                </div>
                <div class="custom-options">
                    <span class="custom-option" data-value="aurora-veil" style="background: linear-gradient(to right, #32CD32, #00FFFF, #8A2BE2);">Velo de aurora</span>
                    <span class="custom-option" data-value="twilight" style="background: linear-gradient(to right, #50C878, #0F52BA, #FF00FF);">Crepúsculo</span>
                    <span class="custom-option" data-value="forest" style="background: linear-gradient(to right, #228B22, #87CEEB, #E6E6FA);">Niebla del bosque</span>
                    <span class="custom-option" data-value="ocean-mist" style="background: linear-gradient(to right, #001F3F, #3D9970, #E0FFFF);">Niebla marina</span>
                    <span class="custom-option" data-value="solar" style="background: linear-gradient(to right, #FFD700, #DC143C, #2E0854);">Solar</span>
                    <span class="custom-option" data-value="crimson" style="background: linear-gradient(to right, #FFC0CB, #C21E56, #420D09);">Carmesí</span>
                    <span class="custom-option" data-value="monochrome" style="background: linear-gradient(to right, #2C2C2C, #C0C0C0, #FFFFFF);">Monocromo</span>
                    <span class="custom-option" data-value="horizon" style="background: linear-gradient(to right, #708090, #4682B4, #FFFFF0);">Horizonte</span>
                </div>
            </div>
            <input type="hidden" id="colorThemeSelect"> 
        </div>
        <p style="font-size: 0.9rem; opacity: 0.7; margin-top: 0.5rem; font-style: italic;">* Recargar para aplicar</p>
      </div>
    </form>
  `,
  account_es: `
    <h2 style="font-size: 2rem; font-weight: 700; margin-bottom: 2rem;">Configuración de cuenta</h2>
    <form id="account-form">
      <div style="margin-bottom: 1.5rem;">
        <label style="font-size: 1.1rem;">Correo electrónico:
          <input type="email" id="accountEmail" class="preferences-input" placeholder="usuario@ejemplo.com" />
        </label>
      </div>
      <div style="margin-bottom: 1.5rem;">
        <label style="font-size: 1.1rem;">Contraseña:
          <input type="password" id="accountPassword" class="preferences-input" placeholder="••••••••" />
        </label>
        <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; margin-top: 0.5rem; cursor: pointer;">
            <input type="checkbox" id="showPasswordToggle"> <span>Mostrar contraseña</span>
        </label>
      </div>
      <div style="margin-bottom: 1.5rem;">
        <button type="button" id="changePasswordBtn" style="padding: 0.6rem 1.5rem; border-radius: 0.5rem; font-weight: 600; font-size: 1rem; cursor: pointer; border: none; color: white; background: linear-gradient(135deg, #3b82f6, #10b981); transition: opacity 0.2s;" onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">🔒 Cambiar contraseña</button>
        <div id="changePasswordSection" style="display:none; margin-top: 1rem;">
          <div style="margin-bottom: 0.75rem;">
            <label style="font-size: 1rem;">Contraseña actual:
              <input type="password" id="currentPassword" class="preferences-input" placeholder="Ingrese contraseña actual" style="display:block; margin-top:0.25rem; width:100%; max-width:300px;" />
            </label>
          </div>
          <div style="margin-bottom: 0.75rem;">
            <label style="font-size: 1rem;">Nueva contraseña:
              <input type="password" id="newPassword" class="preferences-input" placeholder="Ingrese nueva contraseña" style="display:block; margin-top:0.25rem; width:100%; max-width:300px;" />
            </label>
          </div>
          <div style="margin-bottom: 0.75rem;">
            <label style="font-size: 1rem;">Confirmar nueva contraseña:
              <input type="password" id="confirmNewPassword" class="preferences-input" placeholder="Confirmar nueva contraseña" style="display:block; margin-top:0.25rem; width:100%; max-width:300px;" />
            </label>
          </div>
          <button type="button" id="savePasswordBtn" style="padding: 0.5rem 1.25rem; border-radius: 0.5rem; font-weight: 600; font-size: 0.95rem; cursor: pointer; border: none; color: white; background: #16a34a; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">Guardar contraseña</button>
          <span id="passwordMsg" style="margin-left: 0.75rem; font-size: 0.9rem;"></span>
        </div>
      </div>
    </form>
  `,

};

function renderSettings(category) {
    updateSidebarLanguage();
    // Reapply dark mode after rendering panel
    const darkModeStored = (localStorage.getItem('arisEduDarkMode') === null ? true : localStorage.getItem('arisEduDarkMode') === 'true');
    setTimeout(() => applyDarkMode(darkModeStored), 0);
  // Language switching
  const lang = localStorage.getItem('arisEduLanguage') || 'english';
  let key = category;
  if (category === 'appearance') key = (lang === 'chinese' || lang === 'traditional') ? 'appearance_zh' : (lang === 'spanish') ? 'appearance_es' : 'appearance_en';
  if (category === 'account') key = (lang === 'chinese' || lang === 'traditional') ? 'account_zh' : (lang === 'spanish') ? 'account_es' : 'account_en';
  document.getElementById('settings-panel').innerHTML = settingsOptions[key] || '';
  // Add form logic for each category
  if (category === 'appearance') {
    const darkModeToggle = document.getElementById('darkModeToggle');
    const languageSelect = document.getElementById('languageSelect');
    const colorThemeSelect = document.getElementById('colorThemeSelect');
    // Ensure language dropdown is always visible
    if (languageSelect) languageSelect.style.display = '';
    // Set initial values from localStorage
    if (darkModeToggle) darkModeToggle.checked = (localStorage.getItem('arisEduDarkMode') === null ? true : localStorage.getItem('arisEduDarkMode') === 'true');
    if (languageSelect) languageSelect.value = localStorage.getItem('arisEduLanguage') || 'english';
    
    // Custom Select Logic: Shared for both Color Theme and Background selection
    const colorThemeSelectElement = document.getElementById('colorThemeSelect');
    const backgroundInputElement = document.getElementById('backgroundThemeInput');
    
    if (colorThemeSelectElement || backgroundInputElement) {
        
        // Helper to update UI specifically
        const updateDropdownUI = (wrapperId, value) => {
             const wrapper = document.getElementById(wrapperId);
             if(!wrapper) return;
             
             const triggerSpan = wrapper.querySelector('.custom-select-trigger span');
             const options = wrapper.querySelectorAll('.custom-option');
             const matching = Array.from(options).find(o => o.dataset.value === value);
             
             if(matching) {
                 triggerSpan.textContent = matching.textContent.trim();
                 const style = matching.getAttribute('style');
                 // Use cssText to copy fully, but ensure it overrides
                 if(style && value !== 'default') {
                     triggerSpan.style.cssText = style; 
                     triggerSpan.classList.add('gradient-text-selected');
                 } else {
                     triggerSpan.style.cssText = ''; 
                     triggerSpan.classList.remove('gradient-text-selected');
                     const isChinese = (localStorage.getItem('arisEduLanguage') === 'chinese' || localStorage.getItem('arisEduLanguage') === 'traditional');
                     // Maintain placeholder if needed, but here we matched an option so we use its text.
                 }
             } else {
                 // Fallback if no value match (e.g. initial load without saved value)
                 const isChinese = (localStorage.getItem('arisEduLanguage') === 'chinese' || localStorage.getItem('arisEduLanguage') === 'traditional');
                 triggerSpan.textContent = isChinese ? "選擇主題" : "Select Theme";
                 triggerSpan.style.cssText = '';
                 triggerSpan.classList.remove('gradient-text-selected');
             }
        };

        const setupDropdown = (wrapperId, storageKey, syncGroup = []) => {
            const wrapper = document.getElementById(wrapperId);
            if (!wrapper) return;
            
            const trigger = wrapper.querySelector('.custom-select-trigger');
            const options = wrapper.querySelectorAll('.custom-option');
            
            // Initialization
            const savedValue = localStorage.getItem(storageKey) || (storageKey.includes('Background') ? 'default' : 'blue-green');
            updateDropdownUI(wrapperId, savedValue);

            // Toggle
            trigger.addEventListener('click', function(e) {
                document.querySelectorAll('.custom-select').forEach(w => {
                    if(w !== wrapper) w.classList.remove('open');
                });
                e.stopPropagation();
                wrapper.classList.toggle('open');
            });

            // Selection
            options.forEach(option => {
                option.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const value = this.dataset.value;
                    localStorage.setItem(storageKey, value);

                    // Update UI immediately (self)
                    updateDropdownUI(wrapperId, value);
                    
                    // Sync others in group
                    syncGroup.forEach(id => updateDropdownUI(id, value));
                    
                    wrapper.classList.remove('open');
                    
                    // Apply Global Theme
                    if (window.applyGlobalTheme) window.applyGlobalTheme();
                    else if (window.applyArisTheme) window.applyArisTheme();

                    const isDarkMode = (localStorage.getItem('arisEduDarkMode') === null ? true : localStorage.getItem('arisEduDarkMode') === 'true');
                    applyDarkMode(isDarkMode);
                });
            });
        };

        // Initialize Call
        if(colorThemeSelectElement) {
            setupDropdown('customThemeSelectSuggested', 'arisEduColorTheme', ['customThemeSelectOther']);
            setupDropdown('customThemeSelectOther', 'arisEduColorTheme', ['customThemeSelectSuggested']);
        }
        if(backgroundInputElement) {
            setupDropdown('customBackgroundSelect', 'arisEduBackgroundTheme');
        }

        // Global Closer
        document.addEventListener('click', function(e) {
            const dropdowns = document.querySelectorAll('.custom-select');
            dropdowns.forEach(d => {
                if(!d.contains(e.target)) d.classList.remove('open');
            });
        });
    }


    // Save settings automatically
    if (darkModeToggle) darkModeToggle.addEventListener('change', function() {
      localStorage.setItem('arisEduDarkMode', darkModeToggle.checked);
      if (window.applyGlobalTheme) window.applyGlobalTheme();
      applyDarkMode(darkModeToggle.checked);
    });
    if (languageSelect) languageSelect.addEventListener('change', function() {
      const prevLang = localStorage.getItem('arisEduLanguage') || 'english';
      localStorage.setItem('arisEduLanguage', languageSelect.value);
      renderSettings(category);
      if (window.applyGlobalTheme) window.applyGlobalTheme();
      if (window.applyTranslations) window.applyTranslations();
      const darkModeStored = (localStorage.getItem('arisEduDarkMode') === null ? true : localStorage.getItem('arisEduDarkMode') === 'true');
      applyDarkMode(darkModeStored);
      // Show BETA disclaimer if switching to Chinese or Spanish
      if (prevLang === 'english' && (languageSelect.value === 'chinese' || languageSelect.value === 'spanish')) {
        const disclaimer = document.createElement('div');
        if (languageSelect.value === 'spanish') {
          disclaimer.textContent = 'Modo Español (BETA): Algunos contenidos pueden no estar completamente traducidos.';
        } else {
          disclaimer.textContent = '中文模式 (BETA): 部分内容可能尚未完全翻译或优化。';
        }
        disclaimer.style.position = 'fixed';
        disclaimer.style.bottom = '32px';
        disclaimer.style.right = '32px';
        disclaimer.style.background = '#fbbf24';
        disclaimer.style.color = '#222';
        disclaimer.style.padding = '1rem 2rem';
        disclaimer.style.borderRadius = '1rem';
        disclaimer.style.fontWeight = 'bold';
        disclaimer.style.boxShadow = '0 4px 16px rgba(0,0,0,0.12)';
        disclaimer.style.zIndex = '9999';
        document.body.appendChild(disclaimer);
        setTimeout(() => {
          disclaimer.remove();
        }, 5000);
      }
    });

  }
  if (category === 'account') {
    const accountEmail = document.getElementById('accountEmail');
    const accountPassword = document.getElementById('accountPassword');
    const showPasswordToggle = document.getElementById('showPasswordToggle');

    // Load available email and password (prioritize preference, fallback to login user)
    let savedEmail = localStorage.getItem('arisEduAccountEmail');
    let savedPassword = localStorage.getItem('arisEduAccountPassword');

    if (!savedEmail || !savedPassword) {
         try {
             const userJson = localStorage.getItem('user');
             if (userJson) {
                 const u = JSON.parse(userJson);
                 if (!savedEmail && u.email) savedEmail = u.email;
                 if (!savedPassword && u.password) savedPassword = u.password;
             }
         } catch(e){}
    }
    
    if (accountEmail) accountEmail.value = savedEmail || '';
    if (accountPassword) accountPassword.value = savedPassword || '';
    
    if (accountEmail) accountEmail.addEventListener('input', function() {
      localStorage.setItem('arisEduAccountEmail', accountEmail.value);
      updateTaskbarUsername();
    });
    if (accountPassword) accountPassword.addEventListener('input', function() {
      localStorage.setItem('arisEduAccountPassword', accountPassword.value);
    });

    // Toggle Password Visibility
    if (showPasswordToggle && accountPassword) {
        showPasswordToggle.addEventListener('change', function() {
            accountPassword.type = this.checked ? 'text' : 'password';
        });
    }

    // Change Password
    const changePasswordBtn = document.getElementById('changePasswordBtn');
    const changePasswordSection = document.getElementById('changePasswordSection');
    if (changePasswordBtn && changePasswordSection) {
      changePasswordBtn.addEventListener('click', function() {
        const isVisible = changePasswordSection.style.display !== 'none';
        changePasswordSection.style.display = isVisible ? 'none' : 'block';
      });
    }
    const savePasswordBtn = document.getElementById('savePasswordBtn');
    if (savePasswordBtn) {
      savePasswordBtn.addEventListener('click', function() {
        const currentPw = document.getElementById('currentPassword');
        const newPw = document.getElementById('newPassword');
        const confirmPw = document.getElementById('confirmNewPassword');
        const msg = document.getElementById('passwordMsg');
        const storedPw = localStorage.getItem('arisEduAccountPassword') || '';

        if (!currentPw.value) {
          msg.textContent = '❌ Please enter your current password.';
          msg.style.color = '#ef4444';
          return;
        }
        if (storedPw && currentPw.value !== storedPw) {
          msg.textContent = '❌ Current password is incorrect.';
          msg.style.color = '#ef4444';
          return;
        }
        if (!newPw.value || newPw.value.length < 6) {
          msg.textContent = '❌ New password must be at least 6 characters.';
          msg.style.color = '#ef4444';
          return;
        }
        if (newPw.value !== confirmPw.value) {
          msg.textContent = '❌ Passwords do not match.';
          msg.style.color = '#ef4444';
          return;
        }

        // Save the new password
        localStorage.setItem('arisEduAccountPassword', newPw.value);
        // Also update the user object if it exists
        try {
          const userJson = localStorage.getItem('user');
          if (userJson) {
            const u = JSON.parse(userJson);
            u.password = newPw.value;
            localStorage.setItem('user', JSON.stringify(u));
          }
        } catch(e) {}

        // Update the password field above
        if (accountPassword) accountPassword.value = newPw.value;

        msg.textContent = '✅ Password changed successfully!';
        msg.style.color = '#16a34a';
        currentPw.value = '';
        newPw.value = '';
        confirmPw.value = '';
        setTimeout(function() {
          changePasswordSection.style.display = 'none';
          msg.textContent = '';
        }, 2000);
      });
    }
  }
  // Always update taskbar username after rendering
  updateTaskbarUsername();
}

document.querySelectorAll('.settings-category').forEach(btn => {
  btn.addEventListener('click', function() {
    renderSettings(this.dataset.category);
    // Remove inline styles messing with theme manager
    document.querySelectorAll('.settings-category').forEach(b => {
        b.classList.remove('active');
        b.style.removeProperty('background'); // Let CSS/Theme Manager handle it
    });
    this.classList.add('active');
    
    // Reapply dark mode if enabled
    const darkModeStored = (localStorage.getItem('arisEduDarkMode') === null ? true : localStorage.getItem('arisEduDarkMode') === 'true');
    applyDarkMode(darkModeStored);
    updateTaskbarUsername();
  });
});

function applyDarkMode(darkMode) {
  // Delegate global theme application to theme_manager.js
  if(window.applyArisTheme) {
      window.applyArisTheme();
  }

  // Local UI Specifics (Inputs)
  const accountEmail = document.getElementById('accountEmail');
  const accountPassword = document.getElementById('accountPassword');
  if (accountEmail) {
    accountEmail.style.background = darkMode ? '#273244' : '#fff';
    accountEmail.style.color = darkMode ? '#e2e8f0' : '#0f172a';
    accountEmail.style.border = darkMode ? '1px solid #334155' : '';
  }
  if (accountPassword) {
    accountPassword.style.background = darkMode ? '#273244' : '#fff';
    accountPassword.style.color = darkMode ? '#e2e8f0' : '#0f172a';
    accountPassword.style.border = darkMode ? '1px solid #334155' : '';
  }
  
  // Update styles for dynamically rendered elements that might not be caught by generic theme manager
  updateTaskbarUsername();
}

// NOTE: manageAuroraBackground and gradients are now handled by theme_manager.js

// On load, apply dark mode if stored
function initialRender() {
  const darkModeStored = (localStorage.getItem('arisEduDarkMode') === null ? true : localStorage.getItem('arisEduDarkMode') === 'true');
  const category = 'appearance'; // Default category
  renderSettings(category);
  
  // Highlight the selected category
  setTimeout(() => {
    const selectedBtn = document.querySelector(`.settings-category[data-category="${category}"]`);
    if (selectedBtn) {
         selectedBtn.classList.add('active');
         // We trigger theme update to apply styles to the new active class
         applyDarkMode(darkModeStored);
    }
  }, 0);
}
initialRender();

function updateTaskbarUsername() {
  let username = localStorage.getItem('arisEduAccountEmail') || '';
  // Check for user JSON object
  const userJson = localStorage.getItem('user');
  if (userJson) {
    try {
      const userObj = JSON.parse(userJson);
      if (userObj && (userObj.name || userObj.email)) {
        username = userObj.name || userObj.email;
      }
    } catch (e) {}
  }
  const loginBtn = document.getElementById('login-signup-button');
  if (loginBtn) {
    if (username) {
      loginBtn.textContent = `👤 ${username}`;
      loginBtn.href = '#';
    } else {
      const loginText = (window.globalTranslations && window.globalTranslations['Login/Signup']) || 'Login/Signup';
      loginBtn.textContent = '🔐 ' + loginText;
      loginBtn.href="LoginSignup.html";
    }
  }
}

// Listen for dark mode toggle
document.addEventListener('change', function(e) {
  if (e.target && e.target.id === 'darkModeToggle') {
    const darkMode = e.target.checked;
    localStorage.setItem('arisEduDarkMode', darkMode);
    applyDarkMode(darkMode);
  }
});
</script>

<script>
    // Settings menu toggle is handled by taskbar.js — no duplicate handler needed
    document.addEventListener('DOMContentLoaded', () => {
        // Blank Page / View Background Logic
        const viewBgBtn = document.getElementById('view-bg-button');
        const mainContainer = document.querySelector('.preferences-layout');
        
        if (viewBgBtn && mainContainer) {
            viewBgBtn.addEventListener('click', () => {
                const isHidden = mainContainer.style.display === 'none';
                if (isHidden) {
                    // Show Settings
                    mainContainer.style.display = 'flex';
                    viewBgBtn.textContent = (window.globalTranslations && window.globalTranslations['👁️ View BG']) || '👁️ View BG';
                } else {
                    // Hide Settings (Show only BG)
                    mainContainer.style.display = 'none';
                    viewBgBtn.textContent = (window.globalTranslations && window.globalTranslations['🔙 Settings']) || '🔙 Settings';
                }
            });
        }
    });
</script>

    <!-- ArisEdu Global Search -->

    <script src="scripts/global_translations.js?v=7.0"></script>
    <script src="scripts/spanish_translations.js?v=1.0"></script>
    <script src="../search_data.js?v=2.1"></script>
    <script src="../search_logic.js?v=2.1"></script>
</body>
</html>
